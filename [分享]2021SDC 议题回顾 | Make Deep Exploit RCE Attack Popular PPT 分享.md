> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [bbs.pediy.com](https://bbs.pediy.com/thread-270034.htm)

> [分享]2021SDC 议题回顾 | Make Deep Exploit RCE Attack Popular PPT 分享

RCE 攻击是每一位安全研究员的追求，也是业内研究分析绕不开的技术点，遗憾的是目前网上公开的方法论大都未抓住其技术疼点，仅仅满足诸如弹计算器，反弹 shell。

安恒水滴实验室的安全研究员孙成心先生在此基础上做了大量研究，从自身红队视角出发，对 RCE 漏洞所带来的进一步危害及其深度利用，RCE 利用的规范化和流程化，做出了里程碑式意义的开源工作！

下面就让我们来回顾 [2021 看雪第五届安全开发者峰会](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458396801&idx=1&sn=2d13a137f3d17766558e8689d48fd341&chksm=b18f180b86f8911d25d2ff9e0c50068c4e202187e72f9b77fe1bfcfcc14ffd662805264c7dab&scene=21#wechat_redirect)上**《**Make Deep Exploit RCE Attack Popular** 》**此议题的精彩内容。

演讲嘉宾
====

![](https://bbs.pediy.com/upload/attach/202110/236762_ER7595EE962EWZH.jpg)

【孙成心 - 安恒水滴实验室安全研究员】

孙成心：安恒水滴实验室安全研究员。

近些年一直专注 Java 漏洞安全，CodeQL 漏洞分析、审计。擅长漏洞深度利用，CodeQL 分析研究 Nday，擅长研究漏洞的深度利用，赋能红队。

演讲内容
====

以下为速记全文：

先做个自我介绍，我是安恒水滴实验室的安全研究员，主要做的方向是 Java 安全和静态代码分析这一块。今天给大家带来的演题目是《Make Deep Exploit RCE Attack Popular 》，总共分为以下五个部分。

![](https://bbs.pediy.com/upload/attach/202110/236762_352F5G9USX8596S.jpg)

前言

时下随着网络安全的不断发展，RCE 已经成为了流行词。RCE 攻击也是每一个安全研究员的追求，但其实到目前为止 RCE 很多公开手段仅限于弹计算器或者反弹 shell 之类的。

**RCE Code OR Command（代码还是命令）Exploit？**  

我们假设一个场景，当红队攻击队队员发现某某目标存在某个组件、框架并发现可能存在某 RCE 漏洞。如果这个漏洞很熟悉，当然就直接攻击，但如果是最新漏洞、或者是不熟悉的漏洞。

![](https://bbs.pediy.com/upload/attach/202110/236762_N466DBAVS3VET8H.jpg)

此时大多数人员都可能采取 GitHub、Google、百度三步走策略，但往往发现搜索引擎给出的漏洞复现、漏洞分析文章大多数都是以弹计算器、反弹 shell、DNSLOG 等操作。而这些操作往往在现如今的蓝队的防御和应急水平下是能够很快的发现，这些操作往往是不可采取的。

**我们能做什么呢？**新时代下，当然还不能是 DNSLOG、弹计算器、反弹 shell 操作。RCE 漏洞攻击一直以来都是红队最喜欢的攻击手段之一，其特点能够执行任意代码。往往部分安全研究员其工作特性不参与红蓝对抗，从而没有时间、兴趣研究进一步深度利用。

在新时代下，随着蓝军防守能力不断提高显然这些操作是无法满足红队视角下的需求。但与此同时 RCE 漏洞利用其漏洞利用难度一直也是居高不下，并且 RCE 漏洞利用方式花样百出，不同 RCE 漏洞存在不同漏洞利用方式。而红队队员不可能所有的 RCE 漏洞都复现过、有了解过，或者说是漏洞进一步深度利用过。

![](https://bbs.pediy.com/upload/attach/202110/236762_QFDWUHA7XEJKWZ3.jpg)

ysoserial 是一款知名的漏洞利用工具，其包含目前主流的绝大数的漏洞利用 Gadget，但绝大数的漏洞利用 Gadget 都是以执行命令为主，这使得大多数人将 RCE 漏洞的危害从 " 任意代码执行” 降级为了 “任意命令执行”。

2  

漏洞案例分析

SpringBootVulExploit 是一个对 SpringBoot 漏洞利用 checklist，包含了目前 SpringBoot 绝大数漏洞利用方式，也是目前红队对 SpringBoot 的 checklist。

![](https://bbs.pediy.com/upload/attach/202110/236762_KJ6HZFWGQR2ZQU8.jpg)

checklist 一共给出了（目前）给出十二种 RCE 漏洞利用方法，对其归纳分类。大致可以分为三类，第一类 JNDI 注入攻击类型、重启类型以及其他类型。

JNDI 注入类型都是可以采用 JNDI 注入攻击方法，重启类型都是要将 web 服务重启启动才能触发漏洞。其他类型是一些杂项，每一种的 RCE 漏洞利用都是不同的漏洞利用方式。

站在红队视角下，如果遇到 SpringBoot 漏洞，显然没有一套规范的漏洞利用方案，显然无法做到漏洞快速利用的目的。要对每一种漏洞利用方式从能够复现、到深度漏洞利用是一个很漫长的过程，这个过程可能是一个星期、甚至是一个月。

**如何规范一套漏洞快速利用的方案呢？**这里我认为存在三个痛点：

**（1）漏洞利用规范化：**一套规范的漏洞利用模式，从漏洞发现、漏洞复现、漏洞利用的规范

**（2）漏洞利用流程化：**用一套流程，将漏洞利用规范的每一个细节变成一套流程

**（3）漏洞利用简易化：**将漏洞深度利用难度简易化，让每一个人用尽可能少的时间学习漏洞利用

![](https://bbs.pediy.com/upload/tmp/93_ZYAS7YVHXTNSTNE.jpg)

Checklist 归类后一共有三类，如果将其中两类转化成另一类的话，那么将大大减少漏洞利用难度。第一类就包含了三种均是采用 JNDI 方式，采用 JNDI 的优点：通用性比较强、利用成本低。缺点要求目标出网。如果我们把所有的类型都转换成 JNDI 注入的方式，那么将大大减少我们的漏洞利用的难度。

JNDI 的特点，可以获取实例类、执行任意恶意代码。事先安全研究员可以将漏洞利用的代码写好，实现一次编写循环使用，即使是不懂代码的人都能实现漏洞利用。

如果针对 JNDI 来构造一个 RCE 漏洞利用框架，那么其实分为三者的关系：客户端、服务端以及目标。

![](https://bbs.pediy.com/upload/attach/202110/236762_E4EFQSU9TUYYHVU.jpg)

客户端是红队队员，服务器端是架设的恶意服务，目标是攻击对象。第 0 步，攻击之前确认服务端服务启动且能访问。第一步，发送恶意请求，第二步目标会发生 lookup 请求，第三步服务器端返回恶意类，最后客户端确认漏洞利用成功。

3  

JNDI 注入——“误区”

![](https://bbs.pediy.com/upload/attach/202110/236762_EHRK8FV33C9Z8AH.jpg)

这张图在很多的 JNDI 分析文章频繁出现，这张图表示 JNDI 在各个版本的修复情况，实际上这很容易造成了一个误区。  

JNDI 的数据其实有两种，一种是反序列化数据，一种是引用对象。Java 中的 LDAP 在属性值中存储相关的 Java 对象，可以存储如上两种对象，而相关的问题就是出现在这部分上。

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在 JNDI 发起的 Lookup 后，最终会有解码操作。首先会进行判断，三种情况三种处理。如果是序列化数据上面的条件限制就失效了，这是一个很少人关注的点。

测试使用 JDK9.0.4，也能弹出计算器。完美绕过 “限制”。

前面我们提到 Ysoserial 这款工具，其中生成的代码就限制了只能使用 runtime 执行命令。其实我们只需要将 gadget 生成命令的函数进行修改就能实现执行任意代码的效果。

修改 templates 函数，首先做一个判断，判断输入命令是否是 class 文件。然后直接读取文件字节码，插入 templates 的字段 bytecodes 中即可。需要注意的是类文件的类需要继承 AbstractTranslet，并复写两个抽象方法。下面是一个弹出计算器的示例代码。

![](https://bbs.pediy.com/upload/attach/202110/236762_EUYUEBEG7P3PW22.jpg)

实战化——Spring Boot

根据 JNDI 的漏洞利用框架解决方案思维，就可以解决 SpringBoot 漏洞利用难的问题。对其 payload 进行改造就能满足实现 RCE 漏洞利用的条件，这是 logback JNDI RCE 的改造后的 Payload。

![](https://bbs.pediy.com/upload/attach/202110/236762_56NNXXYR5CFHFAA.jpg)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

SpEL 表达式在很多框架中的使用了，迄今为止也爆出了很多框架存在 SpEL 表达式注入，当然这里也包含 springboot 框架。对 SpEL 表达式注入的 Payload 修改就实现使用 JNDI 方式达到漏洞利用的目的。

CVE-2021-26084Atlassian confluence rce 是前段时间比较火的漏洞，其漏洞本质是 OGNL 表达式注入，这里也可以对其 payload 修改发现是可以采用 JNDI 注入的方式实现漏洞利用的目的。当然只能要是 OGNL 表达式注入就能使用这个 payload，不仅限制于 confluencerce 漏洞利用。

SpringBootExploit 是上述情况研究下的产物，解决了 RCE 漏洞利用难、漏洞利用繁琐的问题，实现了一键 getshell。JNDIExploit 是对应的服务端，配合 SpringBootExploit 使用。

![](https://bbs.pediy.com/upload/attach/202110/236762_655ZTKT699G2FHX.jpg)

RCE 本意是执行任意代码，执行任意代码就能获取任意恶意类，获取恶意类就能进行更多可操作性。上面表格列举的漏洞都能根据框架进行改造实现执行任意代码的目的。

5  

CodeQL 探索 Gadget

上面我们都是直接用 InitialContext 类进行直接调用 Lookup 方法，但在 JdbcRowSetImpl 也是能间接调用 lookup 方法。JdbcRowSetImpl 这个类是 fastjson 低于 1.2.48 版本 RCE 漏洞的 payload 被广泛流传的，其原理是 setAutoCommit 的时候会判断是否存在连接，然后调用 connect 函数。在 connet 函数里面会用 InitialContext.lookup 方法触发漏洞。

![](https://bbs.pediy.com/upload/attach/202110/236762_7G3W5HSQK6MJRXN.jpg)

1、首先 Context 和 InitialContext 的基础之上找到其 “替代” 类（相似类），作用相似功能相似但名字不一样，包名不一样。

2、在第一步基础上进一步找到其类的使用类（例如 JdbcRowSetImpI）。

3、筛选第二步的类，如果满足需求就是一个新的 JNDI 漏洞触发类，甚至可能是一个新 gadget。

使用 CodeQL 根据前面的三步走策略，编写 QL 规则，经过测试 41 项目发现满足条件项目如下。

![](https://bbs.pediy.com/upload/attach/202110/236762_R35946W7XCVNB8P.jpg)

可以发现 spring framework 项目，结果中包含 CVE-2017-8045 中的漏洞触发类。

![](https://bbs.pediy.com/upload/attach/202110/236762_JFCMSPU25RB38XQ.jpg)

log4j 组件是一个日志组件，应用非常广泛。大多数 JavaWeb 日志都使用了。使用 CodeQL 编写规则复现，发现其中存在触发 JNDI 漏洞的类。

![](https://bbs.pediy.com/upload/attach/202110/236762_EETQ9TTM62P5CVG.jpg)

在如何高效地捡漏反序列化漏洞利用链文章中提及到一个新的 JNDI 触发漏洞类，ReistryImpl_Stub 类。

![](https://bbs.pediy.com/upload/attach/202110/236762_CWHAYSKVKCTV65Z.jpg)![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

试想如果有足够多的接口，就能采用三步走策略收集到足够多的组件的漏洞利用类，该计划就因此孕育而生。

![](https://bbs.pediy.com/upload/attach/202110/236762_5VZS2E24HEKSR2X.jpg)

*   shiro550 漏洞原理将 rememberMe 的 cookie 值直接进行 base64 解码，然后 AES 解密之后直接将序列化数据进行反序列化触发漏洞。
    

*   目前最主流 shiro550 漏洞利用 Gadget 是使用 shiro1.2.4 自身自带的 CommonsBeanutils 组件反序列化 Gadget。
    

*   CommonsBeanutils 组件反序列化漏洞目前主流是使用 Ysoserial 工具中的 Gadget 以及 p 牛提出的 Gadget。
    

shiro 框架依赖 CommonsBeanutils，采用相同的分析步骤，通过编写 CodeQL 规则可以挖掘依赖 CommonsBeanutils 组件更多漏洞利用 gadget。

我的演讲到此结束了，谢谢大家！

[【公告】【iPhone 13 大奖等你拿】看雪. 众安 2021 KCTF 秋季赛 防守篇 - 征题倒计时（11 月 14 日截止）！](https://bbs.pediy.com/thread-269228.htm)

最后于 1 小时前 被 kanxue 编辑 ，原因：

上传的附件：

*   [孙成心 -《Make Deep Exploit RCE Attack Popular 》.rar](javascript:void(0)) （9.57MB，2 次下载）