> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.trendmicro.com](https://www.trendmicro.com/en_us/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry.html)

> Citizen Lab has released a report detailing sophisticated iPhone exploits being used against nine Bah......

Citizen Lab has released a [report](https://citizenlab.ca/2021/08/bahrain-hacks-activists-with-nso-group-zero-click-iphone-exploits/) detailing sophisticated iPhone exploits being used against nine Bahraini activists. The activists were reportedly hacked with the NSO Group’s Pegasus spyware using two zero-click iMessage exploits: [Kismet](https://citizenlab.ca/2020/12/the-great-ipwn-journalists-hacked-with-suspected-nso-group-imessage-zero-click-exploit/), which was identified in 2020; and [ForcedEntry](https://citizenlab.ca/2021/08/bahrain-hacks-activists-with-nso-group-zero-click-iphone-exploits/), a new vulnerability that  was identified in 2021. Zero-click attacks are labeled as sophisticated threats because unlike typical malware, they do not require user interaction to infect a device. The latter zero-click spyware is particularly notable because it can bypass security protections such as BlastDoor, which was designed by Apple to protect users against zero-click intrusions such as these. 

According to Citizen Lab’s report, Kismet was used from July to September 2020 and was launched against devices running at least iOS 13.5.1 and 13.7. It was likely not effective against the iOS 14 update in September. Then, in February 2021, the NSO Group started deploying the zero-click exploit that managed to circumvent BlastDoor, which Citizen Lab calls ForcedEntry. Amnesty Tech, a global collective of digital rights advocates and security researchers, also observed zero-click iMessage exploit activity during this period and referred to it as [Megalodon](https://www.amnesty.org/en/latest/research/2021/07/forensic-methodology-report-how-to-catch-nso-groups-pegasus/).   

Diving into ForcedEntry

According to the report from Citizen Lab, when the ForcedEntry exploit was launched against the victim’s device, the device logs showed two types of crashes. The first crash apparently happened when invoking ImageIO’s functionality for rendering Adobe Photoshop PSD data.   

Our analysis focuses on the second crash, which is detailed in Figure 1. This crash happened when invoking CoreGraphics’ functionality for decoding JBIG2-encoded data in a PDF file. This analysis is solely based on samples from Citizen Lab; no new samples were obtained.   

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20Figure%201.png) Figure 1. This image from Citizen Lab shows a Symbolicated Type Two crash for ForcedEntry on an iPhone 12 Pro Max running iOS 14.6. The red highlights from Trend Micro Research.

From this crash log, we can deduce three interesting points: First, the zero-click attack is dependent on iMessage attachment parsing. Next, the slide of dyld_shared_cache is 0, which means all the system modules are loaded into a fixed address. Lastly, the crash point 0x181d6e228 is not the first place of vulnerability exploitation. We discuss the details of these conclusions in the following sections.

**Root cause of CVE-2021-30860**

The vulnerability is inside the function **JBIG2Stream::readTextRegionSeg** of CoreGraphics.framework  The crash point **0x181d6e228** (as seen in box 3  in the preceding figure) is at line 161 of the function JBIG2Stream::readTextRegionSeg of the following screenshot:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Fig2-forcedentry.png) Figure 2. Screenshot of the function JBIG2Stream::readTextRegionSeg showing the crash point

First, it calculates the _numSyms_ according to the JBIG2SymbolDict segment:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20C.png)

The type of _numSyms_ is unsigned int, and the return type of function _seg->getSize()_ is also unsigned int. Therefore, _numSyms_ could be smaller than the size of one JBIG2Segment due to integer overflow. One example is _numSyms=1=(0x80000000+0x80000001) < 0x80000000._

Then, it allocates the heap buffer **syms**, with the size **numSyms * 8** :

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20D.png)

Finally, it fills the _syms_ with the value from bitmap:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20E.png)

The loop times are dependent on the JBIG2Segment size, which could be larger than the buffer _syms_ size. This leads to the out-of-bounds write access for the heap buffer _syms_.

**Looking at Apple’s fix**

Apple patched the function in iOS 14.8:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Fig3-forcedentry.png) Figure 3. Screenshot of the same function JBIG2Stream::readTextRegionSeg with fixes in place

We can see that Apple adds two new boundary checks (the red box in Figure 3), to avoid overflowing the _syms_ buffer.

**On the Pegasus spyware exploitation**

**_Disabling ASLR_**

The **dyld_shared_cache** of version iOS 14.6 (18F72) was loaded into IDA Pro for static analysis, after which a surprising result emerged. We were able to go to the addresses on the call stack directly without rebasing the segment.

As deduced from the screenshot in Figure 1 (see box 2), the slide of dyld_shared_cache is **0**. However, in common crash scenarios, these addresses should be in **slide.**

If the screenshot of the original crash log has not been modified, then the conclusion is worrying. It should be noted that Pegasus already disabled Address Space Layout Randomization (ASLR) before its exploitation.

**_Bypassing PAC_**

By inspecting the address **0x181d6e20c** from Frame 1 of the call stack trace, we can see that register x0, the return value of function JBIG2Stream::findSegment, is a subclass of JBIG2Segment:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20F.png)

There are four kinds of subclasses that override the **getType()** virtual function, but the following code shows that they just return one of the enumerate values:

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Forced%20Entry%20G.png)

For example, **JBIG2SymbolDict::getType** just returns **jbig2SegSymbolDict=1:**

![](https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/analyzing-pegasus-spywares-zero-click-iphone-exploit-forcedentry-/Fig5-forcedentry.png)

Therefore, the **frame 1** should have called the virtual function **seg->getType()**. But in actuality, it was already subverted to the current function itself **(frame 0)**. 

This shows that the virtual functions table of the object **JBIG2Segment** had already been replaced, and the pointer authentication code (PAC) security feature was bypassed. This is significant because the PAC security mechanism was developed to [help prevent zero-click hacking](https://www.vice.com/amp/en/article/pkd4kg/apple-is-going-to-make-it-harder-to-hack-iphones-with-zero-click-attacks?__twitter_impression=true). This also shows that the crash point is not the first place of the vulnerability exploitation. 

Conclusion and recommendations

From the view of attack technologies used, we can see that Pegasus is quite an advanced threat for iOS users. However, it seems that these attacks are being launched on very specific targets, rather than common users.

The information from the recent Pegasus attack is from the forensic analysis of Citizen Lab and Amnesty Tech, and we have not found Pegasus attack samples that are at large yet. We are actively searching and monitoring for these threats and will continue to share more details as our investigation continues.

Essentially, this attack is a very common file format parsing vulnerability. We previously discovered [CVE-2020-9883](https://www.zerodayinitiative.com/advisories/ZDI-20-1238/), a vulnerability similar to ForcedEntry, which could be exploited to do the same as what Pegasus has done here. ForcedEntry’s key point is the exploit technology as it is still unknown how it is able to bypass the PAC and disable ASLR.

In the meantime, we strongly recommend  [updating your device to iOS 14.8](https://support.apple.com/en-us/HT212807). As stated previously, common iOS users are not the target for attacks using this spyware. However, there are simple security steps that users can take. For example, concerned users can block iMessages from unknown senders, while a more drastic step would be to disable the iMessage function completely in the device’s Preferences.

Tags