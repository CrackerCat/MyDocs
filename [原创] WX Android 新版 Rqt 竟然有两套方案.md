> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [bbs.pediy.com](https://bbs.pediy.com/thread-271088.htm)

> [原创] WX Android 新版 Rqt 竟然有两套方案

最近在学习 Android 逆向
================

例子是 libwechatnetwork.so rqt8.0 + 版本, 发现了一个特别好玩的东西就是, 如果 So 层检测到你用了调试器就会走一套算法, 如果是正常用户就会走另外一套算法.

 

这难道就是新型的风控防御手段吗, 那我可得好好的学习借鉴一下. 用在自己的安全产品上!!!

 

这个想法我觉得很不错, 如果一些逆向人员大意了 可能就会去分析简单的风控算法, 到时候服务器一经校验就能立马辨别出当前用户环境是否可信.

具体实现方案分析
========

![](https://bbs.pediy.com/upload/attach/202201/873999_B8XVRFQAHJA3YJX.png)

 

根据分析发现 原来他检测是 **TracerPid:** 这个字段玩过逆向的人员应该都知道 只有附加了调试器 这个值就会为调试器的 ID , 当然现在自改 ROM 能轻松过掉这个检测, 嘻嘻嘻

 

因为楼主一开始并未发现这个东西, 所以把两套 RQT 算法都分析了出来, 第一套很简单 就是正常的两次异或后 加上两次 SHA1 之后进行简单的计算 得到一个 2 开头的 hex 值 轻松搞定

 

而第二套也就是 8.0 版本的 RQT 就比较麻烦了, 但是总归是可破的, 逻辑就是初始化的时候 会 MMAP 初始化一个 Table 然后对 Table 里的值进行各种运算

 

![](https://bbs.pediy.com/upload/attach/202201/873999_N698WRW47BC9A6V.png)

 

计算函数前还获取了 计算这个函数需要的时间 看来他们也知道 这个函数的性能不是很棒啊 , 经过我 Trace 执行了 7000W 次 CPU 指令 好玩好玩

 

总得来说新版的 RQT 就是对初始化的 Tbale 加上一个类似 VMP 的东西 进行计算值, 这个 SO 总体难度不错, 可以给个 5 星, 主要用到了流程平坦化, 指令替代, 字符串混淆 这三种混淆方式, 以及吧所有函数全部以 INLINE 的方式实现, 导致 IDA 分析时机器卡顿.

 

真是佩服他们的安全技术, 我要好好学习, 争取吧他们的技术学到手, 成为一个高手!

[【公告】看雪团队招聘安全工程师，将兴趣和工作融合在一起！看雪 20 年安全圈的口碑，助你快速成长！](https://job.kanxue.com/position-read-1104.htm)

[#逆向分析](forum-161-1-118.htm)