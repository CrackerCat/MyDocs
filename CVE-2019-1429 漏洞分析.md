> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-5QpLpsVfd_SE2OBoyZDlw)

本文作者  Strawberry @ QAX A-TEAM

![](https://mmbiz.qpic.cn/mmbiz_gif/EkibxOB3fs4icwQQAZE6MBepadE7zAutkviaEmicgZWqGCPAvRDxD3EhVvrLJQckeqTGqC7Hmc08MTUxXeaMq5pVXw/640?wx_fmt=gif)

CVE-2019-1429 是 IE Jscript 引擎中存在的一个释放后重用漏洞，漏洞源于垃圾回收机制不能完整跟踪被引用对象，导致该对象存在释放后重用的可能。攻击者可通过诱骗受害者打开恶意的网页或 Office 文档来利用该漏洞，成功的利用可导致远程代码执行。本文对该漏洞原理进行仔细分析，如有不足之处欢迎批评指正

![](https://mmbiz.qpic.cn/mmbiz_gif/EkibxOB3fs4icwQQAZE6MBepadE7zAutkviaEmicgZWqGCPAvRDxD3EhVvrLJQckeqTGqC7Hmc08MTUxXeaMq5pVXw/640?wx_fmt=gif)

声明：本篇文章由 Strawberry@ QAX A-TEAM 原创，仅用于技术研究，不恰当使用会造成危害，严禁违法使用 ，否则后果自负。

QAX A-TEAM

*   **漏洞介绍：**
    ---------
    

下图为 CVE-2019-1429 的漏洞公告，InternetExplorer 脚本引擎在处理内存中的对象时存在一个远程代码执行漏洞，也称为 “脚本引擎内存损坏漏洞”。公告中的信息量并不多。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlCdxZIWJTc4zdnhXe9RvByib8lKqfTtHVbyUlP8iaGKp7s9o97SjmTGsw/640?wx_fmt=png)

*   **漏洞分析及复现：**
    ------------
    

比较补丁前后的 jscript.dll，发现修改了 ScavengeRoots 函数，下面为 NameList::ScavengeRoots 函数补丁前后的伪代码，增加了类型为 0x400C 的处理流程。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlzgk0ia6p6FGXKpZ4OIBia8rHw0ejpyASicQSzbXJGAqKmtHSh7QB3Loiaw/640?wx_fmt=png)

经过一番测试得知，当使用 arguments[0]（包括但不限于）引用变量后会出现 0x400C 类型的对象，补丁之前的程序忽略了这一类的对象，只是处理了类型为 0x80、0x83、0x84 和 0x85 的对象，补丁之后的程序在判断出对象为 0x400C 类型后，会去调用 VAR::Scavenge 函数，该函数的流程和其它 *::ScavengeRoots 的流程类似，最终也会调用 GcContext::Scavenge 函数，会将其第二个参数（某个对象指针吧）所指向的双字节中的第 12 位置 0，若满足一定条件，还会进行一些链表操作。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlruOaNsC4B4m6BpvBGZeoLYIUnFpxTeHKGneDn6ONUkGPuwP3CXPDfQ/640?wx_fmt=png)

经过调试可知，程序在 jscript!NameList::ScavengeRoots+0x19 处会比较 EAX 和 0x80 的大小，对应上图中的 case 0x80，此时 ESI 指向当前正在处理的对象。我们可以在此处下条件断点，当 EAX 值为 0x400C 时断下，程序没有对该对象做任何处理就转而去处理下一个对象，对应补丁前的 defaultcase（跳出本次循环）。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlEBWDYTyYKfIV4mGTKGQ2qyN91jSK0PGiccO3B0bgGobibwzwJOiaDwaicg/640?wx_fmt=png)

重新加载运行程序，使程序在 jscript!NameList::ScavengeRoots+0x19 处断下，查看此时 ESI 指向的内存。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlqHT9HcwLuYPSXVJjDdnlkZJxx5ia3rS5vxU9GVvMPcqicEnylUyuHmeA/640?wx_fmt=png)

根据补丁后的流程，查看 esi 偏移 0x8 处（本次调试为 0x53ec860）指向的内存，取出双字节为 0x80，因而走 LABEL_11 那条流程，会从其偏移 0x8 处取出指针（本次调试为 0x55f5b00），然后处理该指针指向的对象。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlD66mNoz3ibrzh8f7aYJQBDiaNVZQwOMic447jfCHomF0KQmo6sMO6UDvw/640?wx_fmt=png)

继续查看 0x55f5b00 指向的内存，嗯…… 挺整齐的。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlQHQSuJ8ELC9W33u1KZpbPlV6KgIxbibOYlvzZ5Kc9dRIIcWjmmkgAhg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlTDxd6Y4mb01NDSn74ADfhKoCiaia4icAJdHYAOpicrfCLeEsicwsyES3Qicg/640?wx_fmt=png)

然后让程序继续执行，程序在执行 jscript!PrepareInvoke 函数时崩溃了，如上图所示，查看该内存的状态，如下图所示，0x55f5b00 属于 [0x55e0000, 0x55e0000+0x19000] 区间，为 MEM_RESERVE 状态，表明其为保留的地址空间，因而无法访问。使用! heap -p-a edi 查看所在堆，发现其已被释放，所以在这里属于释放后重用。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlKvDnS4zvHPdukNwgTWfSfvOwqLE8oRuOD1RnoYCeibKLynP0aXVRcuw/640?wx_fmt=png)

值得关注的是，补丁后的程序会将 0x55f5b00 指向的对象的标志位置 0。但补丁前的程序没有对其进行任何操作，其指向的双字节为 0x881（第 12 位没有置 0），并且现在无法访问，而 0x55682dc 和 0x53ec860 依然可以正常访问，这里推测该标志位与垃圾回收密切相关。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlN33gFM88aBvpJBllickmibVzlEFzfJiaBeTgRP7SnQj6ovyY0WYfMUFcA/640?wx_fmt=png)

通过查阅资料可知，在 Jscript 引擎中，新对象的内存是从专用的 JavaScript 堆中分配的。当总内存消耗或对象数量超过特定阈值时，垃圾收集器会运行并销毁未引用的对象。也可以通过调用 CollectGarbage 函数显式地触发垃圾收集器进行多余对象的回收。

每个对象有一个标记位，在初始化时将其标记为回收状态（这里为 1），即认为所有对象都可以被回收。然后在垃圾回收之前，遍历根对象，把从它能到达的对象都标记为不可回收，这是标记阶段。然后再执行清理，对于那些遍历根对象时因为没有直接或间接引用而不可达的变量，在清理阶段将它释放掉。  

上面分析的 ScavengeRoots 函数中进行的操作正好符合标记过程：遍历内存对象，如果当前对象的回收标记为 0（不回收该对象），那么就根据类型（0x80、0x83、0x84、0x85），到特定位置取其引用的对象地址，将该对象的回收标记置为 0。下面，我们需要了解一下清理阶段。

重新加载运行程序，在 jscript!NameList::ScavengeRoots+0x19 处下条件断点，查看此次的 “崩溃点”（建议使用虚拟机快照，每次的堆状态保持一致）。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlDwLUVTWOGTAiaqdTPaDboXRYI4iboJZjNJHia63fPVOeztmuTXGy13Aibw/640?wx_fmt=png)

既然还有清理阶段，那么后续一定会对这个地址进行操作，因而在 0xa2f7a60 处下硬件断点并运行程序，程序断在 jscript!GcAlloc::ReclaimGarbage+0x63 处，此时程序正在处理 0xa2f7a60 所指向的内存。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlLlPgfZA8HiaZ8x7bHZAU7k78ayV3r616wycKmQoVia6ibMxG4VfT2bl2g/640?wx_fmt=png)

通过调试发现，程序会顺序释放 0xa2f7a60、0xa2f7a70…… 所引用的内存 0xa2ff558、0xa2ff518 等，这对应了 poc 中的数组元素，每个元素都引用了一个 Object 对象。

由于 0xa2f7a60 指向的双字节为 0x881，所以会走 case 0x81 这条流程，其中，v8->lVal 为其偏移 0x8 处指向的内存。在处理当前样本的过程中，程序会调用 v15(v31,1)，即 jscript!NativeErrorProtoObj<16>::`vector deleting destructor'函数，这个函数最终会调用 ntdll!RtlFreeHeap 函数释放 Object 对象。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlh8sZicicPnhYc7tazbW6dElRZiabYHaC202CeJpR3O4AEWYMgffGsx7rw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQl9sjo5UPe14ZWrNg0tmGC9BRwU8V08EDMhdYdbCyNib633W0oNcnZxyg/640?wx_fmt=png)

在这个漏洞中，还有一个疑问是 0xa2f7a60 这块内存是如何释放的，因而分析到此并没有觉得是完成任务。继续分析程序流程，发现该循环（外面还有一层循环）的判断条件为 do while(esi < ecx),esi 每次递增 0x10。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQl6Fhf7gWqDicvfQFibbtk2uVvaeU76TPMvyR0B1AhvYcyUl4f6DxAdyJw/640?wx_fmt=png)

    0xa2f7a60 处于 0xa2f7548 这个堆中，因而很有可能在循环结束后对这个堆进行一些操作，所以直接在 jscript!GcAlloc::ReclaimGarbage+0x2ac 处下断点，单步执行，发现程序调用了 GcBlockFactory::FreeBlk 函数，参数为 0xa2f7548，如下下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlywWvkxEsFR6bjmIeKRLV83YA536vON1MwFnOvxggqkNGB874EJDNAg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlvhyPHTscYH71wj0vh5Pa9nO4Raia2ss3xLXxKXKksrSYtDUF2M76tibA/640?wx_fmt=png)

  在 GcBlockFactory::FreeBlk 函数中，进入了 else if 流程，注意到 operator delete 函数，在该函数内部调用了 free 函数。因而在调试时可先步过前面的 GcBlock::Link 函数（忽略），跟进 operator delete 函数。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlf5aKHiaBxRWIelO2qRWmlFTcMBDd5uw4uhcyDaXxx8wX3icFYqCRUQow/640?wx_fmt=png)

最终程序调用 ntdll!RtlFreeHeap 释放了 0xa2f7548 处的内存，如下图和下下图所示，这样当程序试图访问这块内存（对应 Object 数组中的元素）的时候，就会触发 UAF。漏洞在于没有正确处理类型为 0x400c 对象引用对象的垃圾回收标志，导致正在被引用的对象被释放。

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlVagMnfIsPK0s6xdopId4m4XziadPOrdvLp0TQhpE5RD793TFTvhOcZA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/EkibxOB3fs485FkNubLySjthfoSfRiaPQlvJycIzVibPeuBpR4MQt08lZAE1CedMAL1UdWDBZqhJEotrXRpNGcr3w/640?wx_fmt=png)