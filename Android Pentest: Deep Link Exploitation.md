> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.hackingarticles.in](https://www.hackingarticles.in/android-pentest-deep-link-exploitation/)

### **Introduction to Deep Links**

In many scenarios an application needs to deal with web based URLs in order to authenticate users using Oauth login, create and transport session IDs and various other test cases. In such scenarios, developers configure deep links, aka, custom URL schemas that tell the application to open a specific type of URL in the app directly. This only works in Android v6.0 and above. The intent filter to accept URIs that have example.com as the host and http:// as URL scheme is defined in an Android Manifest file as follows:

|  | 

<intent-filter android:label="@string/filter_view_http_gizmos">

<action android: />

<category android: />

<category android: />

<!-- Accepts URIs that begin with "http://www.example.com/gizmos” -->

<data android:scheme="http"

android:host="www.example.com"

android:pathPrefix="/gizmos" />

<!-- note that the leading "/" is required for pathPrefix-->

</intent-filter>

 |

Pay focus to **data android:scheme=”http”** and **android:host=”<domain>”**

Similarly, the intent filter to define a custom scheme (eg: to open URLs that open with **example://gizmos.com**) is as follows:

|  | 

<intent-filter android:label="@string/filter_view_example_gizmos">

<action android: />

<category android: />

<category android: />

<!-- Accepts URIs that begin with "example://gizmos” -->

<data android:scheme="example"

android:host="gizmos" />

</intent-filter>

 |

In this article, we’ll be looking at how an attacker can exploit poor implementation of URL schemas to conduct various attacks.

### **Where can it go wrong?**

Oftentimes developers use deep links to pass sensitive data from a web URL to an application like usernames, passwords, and session Ids. An attacker can create an application that fires off an intent and exploit this custom URL scheme (deep link) to perform attacks like:

*   Sensitive data exposure
*   Session hijacking
*   Account takeovers
*   Open redirect
*   LFI
*   XSS using WebView implementation of a Deep Link

For example, a poor implementation would be: **example://api.example.com/v1/users/sessionId=12345**

Here, One can change the session ID to 12346 or 12347, and in the application, that particular user’s session would open as to which that session ID corresponds. This Url could be obtained while traffic analysis and a rogue application/HTML phishing page could trigger that activity and perform account takeover.

Let’s see a basic real-time demonstration of exploiting deep links using drozer.

### **Demonstration**

I have coded this small application that I initially built to demonstrate android hooking and added a deep link scheme to call this activity. To download this app follow here. Ideally, you must decompile this app and figure out what the URL scheme is from the Manifest file. Here is how the application looks like. Read the instructions given in the screenshot.

![](https://i2.wp.com/1.bp.blogspot.com/-UG5dilF2YlI/YA2bNkzesPI/AAAAAAAAtIo/GYe_KSuKYvI7iAhQnhDVj6KvJgwavROtQCLcBGAsYHQ/s16000/1.png?w=640&is-pending-load=1#038;ssl=1)

Now, you’ll notice that you won’t be able to open the activity directly using the button below. Hence, we’ll have to exploit deeplink to launch the activity.

The first step here would be to view the manifest file and check which URL scheme is being used. For that I run the following drozer command:

|  | 

run app.package.manifest in.harshitrajpal.deeplinkexample

 |

Note here, the **<data scheme=””>** has a value **“noob”** so maybe we can fire an intent with a data URL containing a URL of this scheme so that it launches this activity?

![](https://i2.wp.com/1.bp.blogspot.com/-z7ggn71-SyQ/YA2bYOb3THI/AAAAAAAAtIs/fzuLslukVDw84526RqO7CxVLIHT-7TcCQCLcBGAsYHQ/s16000/2.png?w=640&is-pending-load=1#038;ssl=1)

Note: It is to be noted that any activity that is declared under an intent filter is by default exported and hence can be called via a rogue app that fires off that particular intent. Developers must also be very mindful of the fact that mere URL authentication is not sufficient due to this fact.

To view exported activities:

|  | 

run app.activity.info  -a in.harshitrajpal.deeplinkexample

 |

We see DeepLinkActivity being used here.

![](https://i0.wp.com/1.bp.blogspot.com/-NlWfFukUAb4/YA2bf6B1B2I/AAAAAAAAtI0/3u61MbBpbZgxvA-VMIHoOZjVt7LNzAVGgCLcBGAsYHQ/s16000/3.png?w=640&is-pending-load=1#038;ssl=1)

We can launch this activity using our DeepLink exploitation technique. On exploring its source code we see that it is accepting data URL with an intent to perform some action. This action could be authentication, webviews, etc. But for the purpose of demonstration, I have coded a simple 10+50 sum calculator (that we saw in the android hooking article)

![](https://i2.wp.com/1.bp.blogspot.com/-jQybJ1nRFso/YA2blv6LlsI/AAAAAAAAtI4/3_xW_lmBCIYdroFpOBMb02hriGcixXHMgCLcBGAsYHQ/s16000/4.png?w=640&is-pending-load=1#038;ssl=1)

First, let’s see what happens when we open a generic URL:

|  | 

run app.activity.start --action android.intent.action.VIEW --data-url http://google.com

 |

As visible, the intent is fired up in a browser.

![](https://i2.wp.com/1.bp.blogspot.com/-PN_rMgh2OcM/YA2br6AO2rI/AAAAAAAAtJA/rO8X98eN6UYGQB8KeIClLeBAm1aBOUSWQCLcBGAsYHQ/s16000/5.png?w=640&is-pending-load=1#038;ssl=1)

Now, let’s form another query in drozer that’ll fire up DeepLinkActivity.java in our application using deeplink.

|  | 

run app.activity.start --action android.intent.action.VIEW –data-uri noob://harshit.com/auth=sum

 |

This is a random URL that doesn’t mean anything and doesn’t perform any action. I’ve just demonstrated that an authentication action can be performed using deep links like this.

As you can see, this URL has fired up the application class that I had created. This is because Android Manifest has directed the android system to redirect any URL that begins with the scheme **“noob://”** to open up with my application DeepLinkExample

![](https://i1.wp.com/1.bp.blogspot.com/-P41WSEiGUGs/YA2bxAsjnGI/AAAAAAAAtJI/ls1vlZKYu6cB8bAvMjWVc8usftx0RyfQwCLcBGAsYHQ/s16000/6.png?w=640&is-pending-load=1#038;ssl=1)

Now, an attacker could host a phishing page with **“a href”** tag that contains a URL of this scheme, sends this page to a victim via social engineering, he could steal his session ID using this. In the screenshot below you can see one such URL that I’ve crafted to steal session key from the DeepLinkExample app using noob:// scheme.

|  | 

<html>

<body>

<a href="noob://hello.com/yolo?=auth&session=exampleKey">click here to exploit</a>

</body>

</html>

 |

Let’s host this using our python server

|  | 

python3 -m http.server 80

 |

![](https://i2.wp.com/1.bp.blogspot.com/-vqn7HHNIkXI/YA2b11A_q0I/AAAAAAAAtJM/M6vqg9YaVVQDTqXClnTPkbuKLHbBUGuNQCLcBGAsYHQ/s16000/7.png?w=640&is-pending-load=1#038;ssl=1)

Let’s open this HTML link on our mobile browser. We see something like this:

![](https://i1.wp.com/1.bp.blogspot.com/-St_CVJjTrY4/YA2b-0T119I/AAAAAAAAtJQ/G7j6ApV1m4YhkSRKJ_x6m8zKreq9RoDBgCLcBGAsYHQ/s16000/8.png?w=640&is-pending-load=1#038;ssl=1)

On clicking this link our application opens successfully!

![](https://i1.wp.com/1.bp.blogspot.com/-lc18pLnK-hs/YA2cEDPvZvI/AAAAAAAAtJY/TeCvnvoOo1kbnQCE6XUc6ASpYDbDvovOgCLcBGAsYHQ/s16000/9.png?w=640&is-pending-load=1#038;ssl=1)

Now, let’s see another intentionally vulnerable application called InjuredAndroid created by b3nac (Follow [here](https://github.com/B3nac/InjuredAndroid)). This application also has a vulnerable Deep Link activity. Since it is in intent-filter it is exported by default. Hence, we can launch this activity directly using the drozer.

|  | 

run app.activity.info -a b3nac.injuredandroid

 |

We see DeepLinkActivity is exported. We try to call it using drozer

|  | 

run app.activity.start --component b3nac.injuredandroid b3nac.injuredandroid.DeepLinkActivity

 |

![](https://i2.wp.com/1.bp.blogspot.com/-wwKXzCQgOHU/YA2cKfZnYxI/AAAAAAAAtJc/IHF3YUhCi78cQF8FYGdw0wmmzj9ZzbHUgCLcBGAsYHQ/s16000/10.png?w=640&is-pending-load=1#038;ssl=1)

We now, take a look at its manifest file to discover the scheme that’s being used.

|  | 

run app.package.maifest in.harshitrajpal.deeplinkexample

 |

Here, we see the **flag11** scheme being used in DeepLinkActivity.

![](https://i0.wp.com/1.bp.blogspot.com/--CIMo7epGmE/YA2cQTxiJiI/AAAAAAAAtJg/EpWssLKEtTgRosb3mbIh_v6ImdYi8pN8ACLcBGAsYHQ/s16000/11.png?w=640&is-pending-load=1#038;ssl=1)

Now, to open this activity using this custom URL scheme, we can do something like:

|  | 

run app.activity.start --action android.intent.action.VIEW --data-uri flag11://abc.com

 |

![](https://i1.wp.com/1.bp.blogspot.com/-s-B4bziDLsg/YA2cUsinApI/AAAAAAAAtJo/se026dZG0S8-0TBP2aVHG9kW-msceXxIwCLcBGAsYHQ/s16000/12.png?w=640&is-pending-load=1#038;ssl=1)

Alternatively, it can also be exploited using an HTML phishing page and social engineering attack:

|  | 

<html>

<body>

<a href="flag11://hello.com/yolo?=auth&session=exampleKey">click here to exploit</a>

</body>

</html>

 |

|  | 

python3 -m http.server 80

 |

![](https://i2.wp.com/1.bp.blogspot.com/-KpSXg59hP8s/YA2cangnODI/AAAAAAAAtJs/wwLMlNLhQpgx1IBbBAjVJa25Vt9v84z_gCLcBGAsYHQ/s16000/13.png?w=640&is-pending-load=1#038;ssl=1)

Now, clicking on this link in a browser, we see that DeepLinkActivity successfully opens up!

![](https://i1.wp.com/1.bp.blogspot.com/-OCyUfafPRGs/YA2cf8wXv6I/AAAAAAAAtJ0/Zp0_cp93hN4WsPVesAr7qkXGzf94qQjzwCLcBGAsYHQ/s16000/14.png?w=640&is-pending-load=1#038;ssl=1)

How to avoid misuse of insecure deep link implementation

The measures are as follows: –

*   Since deep links are configured within the app, a developer could have a secret value communicated to the app by a remote back end server over a secure transmission protocol.
*   Verification of Deep Links as App Links can be done by setting **android:autoVerify=”true”** in the manifest file
*   One can include a JSON file with the name assetlinks.json in your web server that is described by the web URL intent filter

### **Conclusion**

In the article, we learned how to exploit deep links to eventually cause critical damage. In a well-built application, Deep Link could just be the perfect butterfly effect that leads to many critical vulnerabilities. In the references below, you’ll find some real-time bug bounty reports that include deep link abuse. Thanks for reading.

### **References**

**[https://hackerone.com/reports/401793](https://hackerone.com/reports/401793)** 

**[https://hackerone.com/reports/583987](https://hackerone.com/reports/583987)** 

**[https://hackerone.com/reports/855618](https://hackerone.com/reports/855618)**

**[https://www.nowsecure.com/blog/2019/04/05/how-to-guard-against-mobile-app-deep-link-abuse/](https://www.nowsecure.com/blog/2019/04/05/how-to-guard-against-mobile-app-deep-link-abuse/)**

**Author: Harshit Rajpal** is an InfoSec researcher and left and right brain thinker. Contact **[here](https://in.linkedin.com/in/harshit-rajpal-79bb43103)**